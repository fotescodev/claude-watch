tasks:
  - id: "FE1b"
    title: "Add /session-progress endpoint to Cloudflare worker"
    description: |
      Extend the Cloudflare worker to receive session progress and push to watch.

      IMPLEMENTATION:
      1. Add POST /session-progress endpoint to MCPServer/worker/src/index.ts
      2. Validate request has pairingId and progress data
      3. Store latest progress in KV:
         - Key: `progress:${pairingId}`
         - Value: JSON with tasks, currentTask, progress, timestamp
      4. Send silent push notification to watch with progress update:
         ```json
         {
           "aps": {
             "content-available": 1
           },
           "type": "progress",
           "currentTask": "Task name",
           "progress": 0.33,
           "completedCount": 1,
           "totalCount": 3
         }
         ```
      5. Add GET /session-progress/:pairingId for watch to poll (fallback)

      REFERENCE FILES:
      - MCPServer/worker/src/index.ts (existing endpoints)
      - Look at /request endpoint for APNs push pattern

      TEST:
      ```bash
      curl -X POST https://claude-watch.example.workers.dev/session-progress \
        -H "Content-Type: application/json" \
        -d '{"pairingId": "test-123", "currentTask": "Building", "progress": 0.5}'
      ```
    priority: medium
    parallel_group: 2
    completed: false
    depends_on:
      - "FE1a"
    verification: |
      grep -q "session-progress" MCPServer/worker/src/index.ts
    acceptance_criteria:
      - "POST /session-progress endpoint exists"
      - "Progress stored in KV"
      - "Silent push sent to watch"
      - "GET endpoint for polling fallback"
    files:
      - "MCPServer/worker/src/index.ts"
    tags:
      - enhancement
      - worker
      - progress-tracking
    commit_template: "feat(worker): Add session-progress endpoint"
    status: pending
    assigned_worker: null
    started_at: null
  - id: "FE1c"
    title: "Display task progress in watch MainView"
    description: |
      Update MainView to show real-time task progress from Claude Code.

      IMPLEMENTATION:
      1. Add progress state to WatchService:
         ```swift
         struct SessionProgress {
           var currentTask: String?
           var progress: Double  // 0.0 to 1.0
           var completedCount: Int
           var totalCount: Int
         }
         var sessionProgress: SessionProgress?
         ```

      2. Handle "progress" notification type in ClaudeWatchApp.swift:
         - Parse progress payload from notification
         - Update WatchService.shared.sessionProgress

      3. Update StatusHeader in MainView.swift:
         - When sessionProgress != nil:
           - Show "Working on: [currentTask]"
           - Show progress bar with actual percentage
           - Show "2/6 tasks" count
         - When sessionProgress == nil:
           - Show current idle/waiting state (existing behavior)

      4. Add progress bar view:
         ```swift
         ProgressView(value: progress.progress)
           .progressViewStyle(.linear)
         ```

      UI MOCKUP:
      ```
      ┌─────────────────────┐
      │ Working on:         │
      │ "Running tests"     │
      │ ████████░░░░ 66%    │
      │ 4/6 tasks           │
      └─────────────────────┘
      ```

      REFERENCE:
      - ClaudeWatch/Views/MainView.swift (StatusHeader)
      - ClaudeWatch/Services/WatchService.swift (state management)

      TEST:
      Send test notification:
      ```bash
      xcrun simctl push "Apple Watch Series 11 (46mm)" com.edgeoftrust.claudewatch /tmp/progress-test.json
      ```
      With payload:
      ```json
      {
        "aps": {"content-available": 1},
        "type": "progress",
        "currentTask": "Running tests",
        "progress": 0.66,
        "completedCount": 4,
        "totalCount": 6
      }
      ```
    priority: medium
    parallel_group: 3
    completed: false
    depends_on:
      - "FE1b"
    verification: |
      grep -q "SessionProgress" ClaudeWatch/Services/WatchService.swift && \
      grep -q "currentTask" ClaudeWatch/Views/MainView.swift
    acceptance_criteria:
      - "SessionProgress struct added to WatchService"
      - "Progress notification handler in ClaudeWatchApp"
      - "MainView shows current task name"
      - "Progress bar displays actual percentage"
      - "Task count shown (X/Y tasks)"
      - "Falls back to idle state when no progress"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Services/WatchService.swift"
      - "ClaudeWatch/App/ClaudeWatchApp.swift"
    tags:
      - enhancement
      - ui
      - progress-tracking
    commit_template: "feat(ui): Display real-time task progress"
    status: pending
    assigned_worker: null
    started_at: null
current_group: 2
