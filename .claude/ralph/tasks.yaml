# watchOS Ralph Loop - Task Definition
# This file defines all tasks for the autonomous coding loop.
# Tasks are processed by priority within parallel groups.
#
# ARCHIVE: Completed tasks moved to .claude/archive/ralph/tasks-completed-2026-01-18.yaml
# DONE: APNs, Cloudflare Worker, cc-watch npm package all working

version: "1.0"
project: "ClaudeWatch"
platform: "watchOS"
min_deployment: "10.6"
swift_version: "5.9"
settings:
  require_build_pass: true
  require_accessibility: true
  require_hig_compliance: true
  auto_liquid_glass: true

tasks:
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE: PHYSICAL DEVICE DEPLOYMENT
  # Goal: Run Claude Code terminal, pair physical watchOS app, approve from walk
  #
  # COMPLETED:
  # - APNs credentials configured in Cloudflare Worker
  # - Cloudflare Worker deployed with APNs support
  # - cc-watch npm package working
  #
  # ⚠️  PAIRING FLOW (IMPORTANT - DO NOT USE OLD METHOD):
  # ────────────────────────────────────────────────────
  # NEW (correct):  Watch shows code → User types code into `npx cc-watch` CLI
  # OLD (obsolete): CLI shows code → User types code into watch app
  #
  # The watch INITIATES pairing and DISPLAYS the code.
  # The CLI COMPLETES pairing by RECEIVING the code.
  # ═══════════════════════════════════════════════════════════════════════════

  - id: "PD1"
    title: "Build and install watch app on physical device"
    description: |
      Build the watch app and install on physical Apple Watch.

      Prerequisites:
      1. Physical Apple Watch paired with your iPhone
      2. Apple Developer account
      3. Provisioning profile for physical device

      Steps:
      1. Open Xcode: `open ClaudeWatch.xcodeproj`
      2. Select your physical watch as destination
      3. Sign with your development team
      4. Build and run (Cmd+R)

      If signing issues:
      - Go to Signing & Capabilities
      - Select your Team
      - Let Xcode manage signing

      The app should appear on your watch's home screen.
    priority: critical
    parallel_group: 1
    completed: true  # App already installed on physical watch
    verification: |
      echo "Manual task - verify app installed on physical watch"
    acceptance_criteria:
      - "App builds without errors"
      - "App installs on physical watch"
      - "App launches and shows pairing screen"
    files:
      - "ClaudeWatch.xcodeproj/"
    tags:
      - xcode
      - physical-device
      - manual
    commit_template: "build(watch): Install on physical device"

  - id: "PD2"
    title: "Run pairing flow with physical watch"
    description: |
      Complete pairing between Mac and physical Apple Watch.

      NEW FLOW (watch shows code, CLI reads it):
      1. On physical watch:
         - Open Claude Watch app
         - Tap "Pair Now"
         - Watch displays a 6-digit code

      2. On Mac CLI:
         ```bash
         npx cc-watch
         ```
         - Enter the code FROM the watch INTO the CLI
         - Pairing completes automatically

      3. Verify pairing saved:
         ```bash
         cat ~/.claude-watch/config.json
         ```
         Should contain pairingId

      The hook reads from ~/.claude-watch-pairing, so sync it:
      ```bash
      jq -r .pairingId ~/.claude-watch/config.json > ~/.claude-watch-pairing
      ```
    priority: critical
    parallel_group: 2
    completed: true  # Paired successfully
    depends_on:
      - "PD1"
    verification: |
      [ -f ~/.claude-watch-pairing ] && exit 0 || exit 1
    acceptance_criteria:
      - "Pairing helper runs successfully"
      - "Watch shows 'Connected' status"
      - "~/.claude-watch-pairing contains valid UUID"
    files:
      - ".claude/hooks/claude-watch-pair.py"
    tags:
      - pairing
      - physical-device
    commit_template: "test(pairing): Complete physical watch pairing"

  - id: "PD3"
    title: "Enable PreToolUse hook for watch approvals"
    description: |
      Enable the hook that routes Claude Code permission prompts to the watch.

      The hook is in .claude/settings.json but currently disabled (PreToolUse: []).

      To enable:
      ```bash
      ./.claude/hooks/toggle-watch-hooks.sh
      ```

      Or manually edit .claude/settings.json:
      ```json
      "PreToolUse": [
        {
          "matcher": "Bash|Write|Edit|MultiEdit",
          "hooks": [
            {
              "type": "command",
              "command": "python3 \"$CLAUDE_PROJECT_DIR\"/.claude/hooks/watch-approval-cloud.py"
            }
          ]
        }
      ]
      ```

      Note: In dev mode, you may want hooks disabled. Toggle as needed.
    priority: high
    parallel_group: 3
    completed: true  # Hook enabled
    depends_on:
      - "PD2"
    verification: |
      jq -e '.hooks.PreToolUse | length > 0' .claude/settings.json >/dev/null 2>&1
    acceptance_criteria:
      - "PreToolUse hook enabled in settings.json"
      - "Hook points to watch-approval-cloud.py"
      - "Matcher includes Bash|Write|Edit|MultiEdit"
    files:
      - ".claude/settings.json"
      - ".claude/hooks/toggle-watch-hooks.sh"
    tags:
      - hooks
      - configuration
    commit_template: "feat(hooks): Enable watch approval hook"

  - id: "PD4"
    title: "Test end-to-end approval flow (THE DOG WALK TEST)"
    description: |
      THE FINAL TEST: Walk your dog while approving Claude Code requests.

      SIMULATOR TEST: ✅ PASSED (2026-01-18)
      - Notification received correctly
      - Main view updates live when request arrives
      - Approve/Reject buttons functional
      - MainActor fix deployed

      E2E TEST: ✅ PASSED (2026-01-18)
      - Hook blocks Claude Code until watch approval
      - Push notification arrives when app backgrounded
      - Approve from watch → Claude Code proceeds
      - Full remote control flow verified

      Setup:
      1. Physical watch paired and app running
      2. APNs configured and working (DONE)
      3. PreToolUse hook enabled
      4. Claude Code running on Mac

      Test Steps:
      1. Start Claude Code session on Mac
      2. Ask Claude to make a file change (e.g., "add a comment to MainView.swift")
      3. Physical watch should:
         - Receive push notification (may take 1-2 seconds)
         - Show request details
         - Provide Approve/Reject buttons
      4. Tap Approve on watch
      5. Claude Code should continue and make the change
      6. Test rejection: Ask for another change, tap Reject
      7. Claude Code should stop and report rejection

      Go for a walk:
      - Leave Mac running Claude Code
      - Walk away with watch
      - Approve/reject from anywhere with internet
    priority: critical
    parallel_group: 4
    completed: true
    depends_on:
      - "PD3"
    verification: |
      echo "Manual testing task - mark complete after successful walk test"
    acceptance_criteria:
      - "Push notification received on physical watch"
      - "Request details displayed correctly"
      - "Approve proceeds Claude Code action"
      - "Reject stops Claude Code action"
      - "Works while walking away from Mac"
      - "Latency acceptable (< 5 seconds)"
    files: []
    tags:
      - testing
      - e2e
      - physical-device
      - manual
    commit_template: "test(e2e): Verify physical watch approval flow"

  # ═══════════════════════════════════════════════════════════════════════════
  # FUTURE ENHANCEMENTS
  # ═══════════════════════════════════════════════════════════════════════════

  - id: "FE1"
    title: "Real task progress tracking from Claude Code sessions"
    description: |
      The "Ready for tasks" / "0%" progress indicator is currently static.
      Should reflect actual Claude Code session activity:
      - Track when a session starts/ends
      - Show task count and progress from Claude's TodoWrite
      - Update progress bar based on completed vs pending tasks
      - Show "Working on: [task name]" when actively processing

      Requires: Extending the hook/worker protocol to send session metadata.
    priority: low
    parallel_group: 99
    completed: false
    tags:
      - enhancement
      - deferred
    commit_template: "feat(progress): Real task progress tracking"

  # ═══════════════════════════════════════════════════════════════════════════
  # BLOCKED/DEFERRED TASKS
  # ═══════════════════════════════════════════════════════════════════════════

  - id: "SP1"
    title: "Add clipboard paste button for pairing"
    description: |
      BLOCKED: UIPasteboard is NOT available on watchOS.

      Requires WatchConnectivity + iPhone companion app.
      Deferred until after physical device flow works.
    priority: low
    parallel_group: 99
    completed: true  # Marked complete to skip
    blocked: true
    blocked_reason: "UIPasteboard not available on watchOS. Requires iPhone companion app."
    verification: |
      exit 0  # Skip
    acceptance_criteria:
      - "DEFERRED - requires iPhone companion app"
    files: []
    tags:
      - pairing
      - blocked
      - deferred
    commit_template: "feat(pairing): Add clipboard paste (deferred)"
