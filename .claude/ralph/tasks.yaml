# watchOS Ralph Loop - Task Definition
# This file defines all tasks for the autonomous coding loop.
# Tasks are processed by priority within parallel groups.

version: "1.0"
project: "ClaudeWatch"
platform: "watchOS"
min_deployment: "10.6"
swift_version: "5.9"
settings:
  require_build_pass: true
  require_accessibility: true
  require_hig_compliance: true
  auto_liquid_glass: true
tasks:
  # ═══════════════════════════════════════════════════════════════════════════
  # TEST TASK - Verify Ralph Loop Works
  # Parallel Group 0: Highest priority for testing
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "TEST1"
    title: "Add RALPH_TEST marker comment to MainView.swift"
    description: |
      Add a comment marker "// RALPH_TEST: Loop verification successful"
      at the top of MainView.swift (after the imports).
      This verifies the Ralph Loop can make code changes.
    priority: critical
    parallel_group: 0
    completed: true
    verification: |
      grep -q 'RALPH_TEST' ClaudeWatch/Views/MainView.swift && exit 0 || exit 1
    acceptance_criteria:
      - "MainView.swift contains RALPH_TEST marker comment"
    files:
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - test
      - loop-verification
    commit_template: "test(ralph): Add loop verification marker"
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 1: CRITICAL - App Store Blockers
  # Parallel Group 1: Can run concurrently
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "C1"
    title: "Add accessibility labels to all interactive elements"
    description: |
      Add .accessibilityLabel() modifiers to all Button, NavigationLink,
      and interactive elements in MainView.swift and SettingsView.swift.
      This is required for App Store approval and VoiceOver support.
    priority: critical
    parallel_group: 1
    completed: true
    verification: |
      count=$(grep -r 'accessibilityLabel' ClaudeWatch/Views/*.swift 2>/dev/null | wc -l);
      [ "$count" -ge 10 ] && exit 0 || exit 1
    acceptance_criteria:
      - "Every Button has .accessibilityLabel()"
      - "Every NavigationLink has .accessibilityLabel()"
      - "VoiceOver announces all elements correctly"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Views/SettingsView.swift"
    tags:
      - accessibility
      - app-store
      - hig
    commit_template: "fix(a11y): Add accessibility labels to interactive elements"
  - id: "C2"
    title: "Create app icon assets for all required sizes"
    description: |
      Generate PNG app icons for all 16 required watchOS sizes.
      Use the Claude logo or create appropriate branding.
      Icons must be provided for all sizes in Contents.json.
    priority: critical
    parallel_group: 1
    completed: true
    verification: |
      count=$(ls ClaudeWatch/Assets.xcassets/AppIcon.appiconset/*.png 2>/dev/null | wc -l);
      [ "$count" -ge 8 ] && exit 0 || exit 1
    acceptance_criteria:
      - "PNG files exist for all required sizes"
      - "Icons render correctly in simulator"
      - "No placeholder or missing images"
    files:
      - "ClaudeWatch/Assets.xcassets/AppIcon.appiconset/"
    tags:
      - assets
      - app-store
    commit_template: "feat(assets): Add watchOS app icon assets"
  # ═══════════════════════════════════════════════════════════════════════════
  # Parallel Group 2: Depends on Group 1
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "C3"
    title: "Add AI data consent dialog on first launch"
    description: |
      Display consent dialog on first launch explaining:
      - Data sent to Claude API for processing
      - Voice transcription handling
      - No data sold to third parties
      Use @AppStorage to track consent state.
    priority: critical
    parallel_group: 2
    completed: true
    depends_on:
      - "C1"
    verification: |
      grep -q 'hasAcceptedConsent\|ConsentView\|privacyConsent' ClaudeWatch/ -r && exit 0 || exit 1
    acceptance_criteria:
      - "Consent view shown on first launch"
      - "@AppStorage tracks consent state"
      - "User can review consent in Settings"
    files:
      - "ClaudeWatch/Views/ConsentView.swift"
      - "ClaudeWatch/App/ClaudeWatchApp.swift"
      - "ClaudeWatch/Views/SettingsView.swift"
    tags:
      - privacy
      - app-store
      - onboarding
    commit_template: "feat(privacy): Add AI data consent dialog"
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 2: HIGH PRIORITY - Quality & Polish
  # Parallel Group 3: Can run concurrently
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "H1"
    title: "Fix font sizes below 11pt minimum"
    description: |
      Replace hardcoded font sizes in ComplicationViews.swift with
      semantic styles. Ensure all text meets 11pt minimum per HIG.
      Use .caption, .caption2, .footnote instead of explicit sizes.
    priority: high
    parallel_group: 3
    completed: true
    verification: |
      ! grep -E '\.font\(.*size:\s*([0-9]|10)\.' ClaudeWatch/ -r 2>/dev/null
    acceptance_criteria:
      - "No font sizes below 11pt"
      - "Use semantic styles where possible"
      - "Complications remain readable"
    files:
      - "ClaudeWatch/Complications/ComplicationViews.swift"
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - hig
      - typography
      - accessibility
    commit_template: "fix(hig): Ensure minimum 11pt font sizes"
  - id: "H2"
    title: "Wire App Groups for complication data sharing"
    description: |
      Configure App Groups entitlement and use UserDefaults(suiteName:)
      for sharing state between main app and complications.
    priority: high
    parallel_group: 3
    completed: true
    verification: |
      grep -q 'group.com' ClaudeWatch/*.entitlements 2>/dev/null || \
      grep -q 'suiteName' ClaudeWatch/Services/*.swift 2>/dev/null
    acceptance_criteria:
      - "App Groups entitlement configured"
      - "Complications can read shared state"
      - "State persists across app launches"
    files:
      - "ClaudeWatch/ClaudeWatch.entitlements"
      - "ClaudeWatch/Services/WatchService.swift"
      - "ClaudeWatch/Complications/ComplicationViews.swift"
    tags:
      - entitlements
      - complications
      - state
    commit_template: "feat(complications): Wire App Groups for data sharing"
  - id: "H3"
    title: "Add recording indicator for voice input"
    description: |
      Show visual indicator when microphone is active.
      Required by App Store guidelines for privacy.
      Include haptic feedback on start/stop.
    priority: high
    parallel_group: 3
    completed: true
    verification: |
      grep -q 'isRecording\|RecordingIndicator\|recordingState' ClaudeWatch/Views/ -r
    acceptance_criteria:
      - "Red dot or pulsing indicator during recording"
      - "Indicator visible in all lighting conditions"
      - "Haptic feedback on recording start/stop"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Views/Components/RecordingIndicator.swift"
    tags:
      - voice
      - privacy
      - app-store
    commit_template: "feat(voice): Add recording indicator"
  - id: "H4"
    title: "Update Swift version to 5.9+ in build settings"
    description: |
      Update SWIFT_VERSION in project.pbxproj from 5.0 to 5.9.
      Enable strict concurrency checking for better safety.
    priority: high
    parallel_group: 3
    completed: true
    verification: |
      grep -q 'SWIFT_VERSION = 5\.[9]' ClaudeWatch.xcodeproj/project.pbxproj || \
      grep -q 'SWIFT_VERSION = 6' ClaudeWatch.xcodeproj/project.pbxproj
    acceptance_criteria:
      - "Swift 5.9+ in build settings"
      - "No compilation errors"
      - "Strict concurrency warnings addressed"
    files:
      - "ClaudeWatch.xcodeproj/project.pbxproj"
    tags:
      - build
      - swift
      - quality
    commit_template: "build: Update Swift version to 5.9"
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 3: MEDIUM PRIORITY - Enhancement
  # Parallel Group 4: Can run concurrently
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "M1"
    title: "Implement Digital Crown support"
    description: |
      Add .digitalCrownRotation() for scrolling lists and adjusting values.
      Provide haptic feedback on detent boundaries.
    priority: medium
    parallel_group: 4
    completed: true
    verification: |
      grep -q 'digitalCrownRotation\|DigitalCrown' ClaudeWatch/Views/ -r
    acceptance_criteria:
      - "Crown scrolls message history"
      - "Haptic feedback on boundaries"
      - "Smooth rotation feel"
    files:
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - hig
      - input
      - haptics
    commit_template: "feat(input): Add Digital Crown support"
  - id: "M2"
    title: "Add Always-On Display support"
    description: |
      Detect .isLuminanceReduced environment and show simplified UI.
      Reduce colors, hide animations, show essential info only.
    priority: medium
    parallel_group: 4
    completed: true
    verification: |
      grep -q 'isLuminanceReduced' ClaudeWatch/Views/ -r
    acceptance_criteria:
      - "Simplified UI in always-on mode"
      - "No bright colors or animations"
      - "Connection status always visible"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Complications/ComplicationViews.swift"
    tags:
      - always-on
      - hig
      - battery
    commit_template: "feat(display): Add Always-On Display support"
  - id: "M3"
    title: "Add Dynamic Type support"
    description: |
      Use .dynamicTypeSize environment and prefer semantic fonts.
      Test with all accessibility sizes.
      Use @ScaledMetric for custom sizes.
    priority: medium
    parallel_group: 4
    completed: true
    verification: |
      grep -q 'dynamicTypeSize\|@ScaledMetric\|DynamicType' ClaudeWatch/Views/ -r
    acceptance_criteria:
      - "Text scales with system setting"
      - "Layout adapts to larger sizes"
      - "No text truncation at largest size"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Views/SettingsView.swift"
    tags:
      - accessibility
      - typography
      - hig
    commit_template: "feat(a11y): Add Dynamic Type support"
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 4: WATCHOS 26 / LIQUID GLASS
  # Parallel Group 5: Can run concurrently
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "LG1"
    title: "Adopt Liquid Glass materials"
    description: |
      Replace .opacity() backgrounds with .ultraThinMaterial or .thinMaterial.
      Update to translucent, depth-aware UI components using SwiftUI's
      built-in Material types (.ultraThinMaterial, .thinMaterial, .regularMaterial).
      These provide the glass-like effect available in watchOS 10+.
    priority: medium
    parallel_group: 5
    completed: true
    verification: |
      grep -qE 'ultraThinMaterial|thinMaterial|regularMaterial|\.background\(\..*Material' ClaudeWatch/Views/ -r
    acceptance_criteria:
      - "Material backgrounds on primary containers"
      - "Uses SwiftUI Material types (ultraThinMaterial, thinMaterial, etc.)"
      - "Maintains readability"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Views/Components/"
    tags:
      - liquid-glass
      - watchos26
      - design
    commit_template: "feat(design): Adopt Liquid Glass materials"
  - id: "LG2"
    title: "Add spring animations"
    description: |
      Replace linear animations with .spring() for natural feel.
      Use .animation(.bouncy) or .interpolatingSpring() for interactive elements.
      Spring animations make UI feel more responsive and natural.
    priority: low
    parallel_group: 5
    completed: true
    verification: |
      grep -qE '\.spring\(|interpolatingSpring|animation\(\.bouncy|\.bouncy\)' ClaudeWatch/Views/ -r
    acceptance_criteria:
      - "Buttons use spring animations"
      - "Transitions feel natural"
      - "No jarring or abrupt motion"
    files:
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - animation
      - liquid-glass
      - hig
    commit_template: "feat(animation): Add spring animations"
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 5: TESTING & DOCUMENTATION
  # Parallel Group 6
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "T1"
    title: "Add UI tests for critical flows"
    description: |
      Create XCUITest cases for:
      - App launch and consent flow
      - Connection status display
      - Approval/rejection actions
      - Settings navigation
      Note: Tests should be added to ClaudeWatch/Tests/ directory.
    priority: medium
    parallel_group: 6
    completed: true
    verification: |
      ls ClaudeWatch/Tests/UI*.swift 2>/dev/null | wc -l | grep -q '[1-9]'
    acceptance_criteria:
      - "UI tests for main user flows"
      - "Tests pass on simulator"
      - "Good coverage of critical paths"
    files:
      - "ClaudeWatch/Tests/"
    tags:
      - testing
      - quality
    commit_template: "test(ui): Add UI tests for critical flows"

  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 6: SEAMLESS PAIRING - Reduce pairing friction
  # Parallel Group 7: Can run concurrently
  # Spec: docs/specs/SEAMLESS_PAIRING_SPEC.md
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "SP1"
    title: "Add clipboard paste button for pairing"
    description: |
      ⚠️ BLOCKED: UIPasteboard is NOT available on watchOS.

      The original plan to use UIPasteboard.general cannot work on watchOS.
      UIPasteboard is an iOS-only API - watchOS does not have direct clipboard access.

      ALTERNATIVE APPROACH (requires Phase 8 - iPhone companion app):
      Use WatchConnectivity to sync clipboard from paired iPhone:
      1. Create iPhone companion app target
      2. On iPhone: Read UIPasteboard and send via WCSession.sendMessage
      3. On Watch: Receive message and populate pairing code field

      This task is DEFERRED until after MVP (SP2 + SP4) ships.
      The numeric input approach (SP2) eliminates most of the friction
      that clipboard paste was meant to solve.

      For now, users can:
      1. Type the 6-digit numeric code (SP2)
      2. Use deep link from terminal (SP3, if implemented)
    priority: low
    parallel_group: 8
    completed: true  # Marked complete to skip - redesign needed
    blocked: true
    blocked_reason: "UIPasteboard not available on watchOS. Requires WatchConnectivity + iPhone companion app."
    verification: |
      # Skip - task blocked
      exit 0
    acceptance_criteria:
      - "DEFERRED - requires iPhone companion app"
    files:
      - "ClaudeWatch/Views/PairingView.swift"
    tags:
      - pairing
      - ux
      - clipboard
      - blocked
    commit_template: "feat(pairing): Add clipboard paste button for seamless pairing"

  - id: "SP2"
    title: "Add numeric-only pairing code input option"
    description: |
      Add support for numeric-only pairing codes (6 digits like "123456")
      alongside the existing alphanumeric format. Numeric codes are faster
      to type on the watch.

      RESEARCH FINDINGS (2026-01-17):
      - watchOS doesn't have .numberPad keyboard type like iOS
      - Use TextFieldLink (watchOS 10+) with custom input validation
      - Set .textContentType(.oneTimeCode) for autofill hints
      - Leading zeros must be preserved (e.g., "012345")

      Implementation:
      1. Add TextFieldLink for numeric code entry
      2. Validate exactly 6 digits (allow leading zeros)
      3. Update code validation to accept both formats:
         - Alphanumeric: ABC-123 (7 chars with hyphen)
         - Numeric: 123456 (6 digits, no hyphen)
      4. Show inline error for invalid input
      5. Add haptic feedback on validation

      The server already normalizes codes, so this is primarily a UX change
      on the watch side to support faster numeric input.
    priority: high
    parallel_group: 7
    completed: false
    verification: |
      grep -qE 'TextFieldLink|isNumericCode|numericFormat|oneTimeCode|validateCode' ClaudeWatch/Views/PairingView.swift && exit 0 || exit 1
    acceptance_criteria:
      - "TextFieldLink for code entry (watchOS 10+)"
      - "Accepts 6-digit codes with leading zeros"
      - "Maintains support for ABC-123 format"
      - "Validation works for both formats"
      - "Inline error display for invalid codes"
      - "Haptic feedback on validation"
    files:
      - "ClaudeWatch/Views/PairingView.swift"
    tags:
      - pairing
      - ux
      - keyboard
    commit_template: "feat(pairing): Add numeric code input for faster pairing"

  - id: "SP3"
    title: "Add deep link URL scheme support for pairing"
    description: |
      DEFERRED: Not needed for MVP. SP2 (numeric input) solves the friction problem.

      Register claude-watch:// URL scheme to enable deep linking directly
      into the pairing flow with a pre-filled code.

      Implementation (when needed):
      1. Add URL scheme to Info.plist:
         - CFBundleURLTypes with CFBundleURLSchemes: ["claude-watch"]
      2. Handle .onOpenURL in ClaudeWatchApp.swift
      3. Parse URL: claude-watch://pair?code=ABC123

      RESEARCH FINDINGS (2026-01-17):
      - Adds complexity without proportional UX benefit
      - Requires QR code generation on server side
      - Users still need to scan/click - numeric typing is comparable effort
      - Consider for Phase 8 after MVP validation
    priority: low
    parallel_group: 8
    completed: true  # Deferred - not needed for MVP
    deferred: true
    deferred_reason: "SP2 (numeric input) provides sufficient UX improvement for MVP"
    verification: |
      # Deferred - skip verification
      exit 0
    acceptance_criteria:
      - "DEFERRED - implement after MVP validation"
    files:
      - "ClaudeWatch/App/ClaudeWatchApp.swift"
      - "ClaudeWatch/Info.plist"
    tags:
      - pairing
      - deep-links
      - url-scheme
      - deferred
    commit_template: "feat(pairing): Add deep link URL scheme support"

  - id: "SP4"
    title: "Add server-side numeric code generation with rate limiting"
    description: |
      Update the Cloudflare Worker to support generating numeric-only
      pairing codes as an alternative to alphanumeric codes.

      SECURITY REQUIREMENT (from research 2026-01-17):
      Numeric codes reduce entropy from ~30 bits to ~20 bits.
      MUST add rate limiting to prevent brute force attacks.

      Implementation:
      1. Add optional ?format=numeric query param to POST /pair endpoint
      2. If format=numeric, generate 6-digit code using crypto.getRandomValues
      3. Preserve leading zeros (e.g., "012345" not "12345")
      4. Add rate limiting via Cloudflare KV:
         - Max 5 attempts per pairing ID per 15 minutes
         - Return 429 with retryAfter when exceeded
      5. Store numeric codes the same way in KV
      6. Lookup should work for both formats

      Rate limiting pattern:
      ```javascript
      const RATE_LIMIT = { maxAttempts: 5, windowMs: 15 * 60 * 1000 };
      async function checkRateLimit(pairingId, env) {
        const key = `rate:${pairingId}`;
        const attempts = parseInt(await env.KV.get(key) || '0');
        if (attempts >= RATE_LIMIT.maxAttempts) {
          return { blocked: true, retryAfter: RATE_LIMIT.windowMs };
        }
        await env.KV.put(key, String(attempts + 1), { expirationTtl: 900 });
        return { blocked: false };
      }
      ```
    priority: high
    parallel_group: 7
    completed: false
    verification: |
      grep -qE 'format.*numeric|numericCode|generateNumeric|rateLimit|RATE_LIMIT' MCPServer/worker/src/index.js && exit 0 || exit 1
    acceptance_criteria:
      - "POST /pair accepts ?format=numeric query param"
      - "Generates 6-digit numeric codes with leading zeros preserved"
      - "Rate limiting: max 5 attempts per 15 minutes per pairing ID"
      - "Returns 429 with retryAfter when rate limited"
      - "Default format unchanged (ABC-123)"
      - "Numeric codes stored and retrieved correctly"
    files:
      - "MCPServer/worker/src/index.js"
    tags:
      - pairing
      - server
      - api
      - security
    commit_template: "feat(api): Add numeric pairing code generation with rate limiting"

  - id: "SP5"
    title: "Add pairing code scannability via QR display hint"
    description: |
      DEFERRED: Nice-to-have after MVP. Depends on SP3 (deep links) being implemented.

      When Claude Code displays the pairing code in terminal, also provide
      a hint about the QR code URL that can be used for future scanning.

      Implementation (when needed):
      1. Update server response to include a qrUrl field:
         { code: "ABC-123", qrUrl: "claude-watch://pair?code=ABC-123", ... }
      2. This URL can be:
         - Converted to QR code by CLI tools
         - Clicked if terminal supports hyperlinks
         - Scanned by future iOS companion app

      RESEARCH FINDINGS (2026-01-17):
      - Requires SP3 (deep links) to be useful
      - SP3 is deferred, so SP5 should also be deferred
      - Numeric input (SP2) provides sufficient UX for MVP
    priority: low
    parallel_group: 8
    completed: true  # Deferred - depends on SP3
    deferred: true
    deferred_reason: "Depends on SP3 (deep links) which is deferred"
    verification: |
      # Deferred - skip verification
      exit 0
    acceptance_criteria:
      - "DEFERRED - implement after SP3"
    files:
      - "MCPServer/worker/src/index.js"
    tags:
      - pairing
      - server
      - qr-code
      - deferred
    commit_template: "feat(api): Add QR-scannable deep link URL to pairing response"
