# watchOS Ralph Loop - Task Definition
# This file defines all tasks for the autonomous coding loop.
# Tasks are processed by priority within parallel groups.

version: "1.0"
project: "ClaudeWatch"
platform: "watchOS"
min_deployment: "10.6"
swift_version: "5.9"
settings:
  require_build_pass: true
  require_accessibility: true
  require_hig_compliance: true
  auto_liquid_glass: true
tasks:
  # ═══════════════════════════════════════════════════════════════════════════
  # TEST TASK - Verify Ralph Loop Works
  # Parallel Group 0: Highest priority for testing
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "TEST1"
    title: "Add RALPH_TEST marker comment to MainView.swift"
    description: |
      Add a comment marker "// RALPH_TEST: Loop verification successful"
      at the top of MainView.swift (after the imports).
      This verifies the Ralph Loop can make code changes.
    priority: critical
    parallel_group: 0
    completed: true
    verification: |
      grep -q 'RALPH_TEST' ClaudeWatch/Views/MainView.swift && exit 0 || exit 1
    acceptance_criteria:
      - "MainView.swift contains RALPH_TEST marker comment"
    files:
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - test
      - loop-verification
    commit_template: "test(ralph): Add loop verification marker"
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 1: CRITICAL - App Store Blockers
  # Parallel Group 1: Can run concurrently
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "C1"
    title: "Add accessibility labels to all interactive elements"
    description: |
      Add .accessibilityLabel() modifiers to all Button, NavigationLink,
      and interactive elements in MainView.swift and SettingsView.swift.
      This is required for App Store approval and VoiceOver support.
    priority: critical
    parallel_group: 1
    completed: true
    verification: |
      count=$(grep -r 'accessibilityLabel' ClaudeWatch/Views/*.swift 2>/dev/null | wc -l);
      [ "$count" -ge 10 ] && exit 0 || exit 1
    acceptance_criteria:
      - "Every Button has .accessibilityLabel()"
      - "Every NavigationLink has .accessibilityLabel()"
      - "VoiceOver announces all elements correctly"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Views/SettingsView.swift"
    tags:
      - accessibility
      - app-store
      - hig
    commit_template: "fix(a11y): Add accessibility labels to interactive elements"
  - id: "C2"
    title: "Create app icon assets for all required sizes"
    description: |
      Generate PNG app icons for all 16 required watchOS sizes.
      Use the Claude logo or create appropriate branding.
      Icons must be provided for all sizes in Contents.json.
    priority: critical
    parallel_group: 1
    completed: true
    verification: |
      count=$(ls ClaudeWatch/Assets.xcassets/AppIcon.appiconset/*.png 2>/dev/null | wc -l);
      [ "$count" -ge 8 ] && exit 0 || exit 1
    acceptance_criteria:
      - "PNG files exist for all required sizes"
      - "Icons render correctly in simulator"
      - "No placeholder or missing images"
    files:
      - "ClaudeWatch/Assets.xcassets/AppIcon.appiconset/"
    tags:
      - assets
      - app-store
    commit_template: "feat(assets): Add watchOS app icon assets"
  # ═══════════════════════════════════════════════════════════════════════════
  # Parallel Group 2: Depends on Group 1
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "C3"
    title: "Add AI data consent dialog on first launch"
    description: |
      Display consent dialog on first launch explaining:
      - Data sent to Claude API for processing
      - Voice transcription handling
      - No data sold to third parties
      Use @AppStorage to track consent state.
    priority: critical
    parallel_group: 2
    completed: true
    depends_on:
      - "C1"
    verification: |
      grep -q 'hasAcceptedConsent\|ConsentView\|privacyConsent' ClaudeWatch/ -r && exit 0 || exit 1
    acceptance_criteria:
      - "Consent view shown on first launch"
      - "@AppStorage tracks consent state"
      - "User can review consent in Settings"
    files:
      - "ClaudeWatch/Views/ConsentView.swift"
      - "ClaudeWatch/App/ClaudeWatchApp.swift"
      - "ClaudeWatch/Views/SettingsView.swift"
    tags:
      - privacy
      - app-store
      - onboarding
    commit_template: "feat(privacy): Add AI data consent dialog"
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 2: HIGH PRIORITY - Quality & Polish
  # Parallel Group 3: Can run concurrently
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "H1"
    title: "Fix font sizes below 11pt minimum"
    description: |
      Replace hardcoded font sizes in ComplicationViews.swift with
      semantic styles. Ensure all text meets 11pt minimum per HIG.
      Use .caption, .caption2, .footnote instead of explicit sizes.
    priority: high
    parallel_group: 3
    completed: true
    verification: |
      ! grep -E '\.font\(.*size:\s*([0-9]|10)\.' ClaudeWatch/ -r 2>/dev/null
    acceptance_criteria:
      - "No font sizes below 11pt"
      - "Use semantic styles where possible"
      - "Complications remain readable"
    files:
      - "ClaudeWatch/Complications/ComplicationViews.swift"
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - hig
      - typography
      - accessibility
    commit_template: "fix(hig): Ensure minimum 11pt font sizes"
  - id: "H2"
    title: "Wire App Groups for complication data sharing"
    description: |
      Configure App Groups entitlement and use UserDefaults(suiteName:)
      for sharing state between main app and complications.
    priority: high
    parallel_group: 3
    completed: true
    verification: |
      grep -q 'group.com' ClaudeWatch/*.entitlements 2>/dev/null || \
      grep -q 'suiteName' ClaudeWatch/Services/*.swift 2>/dev/null
    acceptance_criteria:
      - "App Groups entitlement configured"
      - "Complications can read shared state"
      - "State persists across app launches"
    files:
      - "ClaudeWatch/ClaudeWatch.entitlements"
      - "ClaudeWatch/Services/WatchService.swift"
      - "ClaudeWatch/Complications/ComplicationViews.swift"
    tags:
      - entitlements
      - complications
      - state
    commit_template: "feat(complications): Wire App Groups for data sharing"
  - id: "H3"
    title: "Add recording indicator for voice input"
    description: |
      Show visual indicator when microphone is active.
      Required by App Store guidelines for privacy.
      Include haptic feedback on start/stop.
    priority: high
    parallel_group: 3
    completed: true
    verification: |
      grep -q 'isRecording\|RecordingIndicator\|recordingState' ClaudeWatch/Views/ -r
    acceptance_criteria:
      - "Red dot or pulsing indicator during recording"
      - "Indicator visible in all lighting conditions"
      - "Haptic feedback on recording start/stop"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Views/Components/RecordingIndicator.swift"
    tags:
      - voice
      - privacy
      - app-store
    commit_template: "feat(voice): Add recording indicator"
  - id: "H4"
    title: "Update Swift version to 5.9+ in build settings"
    description: |
      Update SWIFT_VERSION in project.pbxproj from 5.0 to 5.9.
      Enable strict concurrency checking for better safety.
    priority: high
    parallel_group: 3
    completed: true
    verification: |
      grep -q 'SWIFT_VERSION = 5\.[9]' ClaudeWatch.xcodeproj/project.pbxproj || \
      grep -q 'SWIFT_VERSION = 6' ClaudeWatch.xcodeproj/project.pbxproj
    acceptance_criteria:
      - "Swift 5.9+ in build settings"
      - "No compilation errors"
      - "Strict concurrency warnings addressed"
    files:
      - "ClaudeWatch.xcodeproj/project.pbxproj"
    tags:
      - build
      - swift
      - quality
    commit_template: "build: Update Swift version to 5.9"
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 3: MEDIUM PRIORITY - Enhancement
  # Parallel Group 4: Can run concurrently
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "M1"
    title: "Implement Digital Crown support"
    description: |
      Add .digitalCrownRotation() for scrolling lists and adjusting values.
      Provide haptic feedback on detent boundaries.
    priority: medium
    parallel_group: 4
    completed: true
    verification: |
      grep -q 'digitalCrownRotation\|DigitalCrown' ClaudeWatch/Views/ -r
    acceptance_criteria:
      - "Crown scrolls message history"
      - "Haptic feedback on boundaries"
      - "Smooth rotation feel"
    files:
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - hig
      - input
      - haptics
    commit_template: "feat(input): Add Digital Crown support"
  - id: "M2"
    title: "Add Always-On Display support"
    description: |
      Detect .isLuminanceReduced environment and show simplified UI.
      Reduce colors, hide animations, show essential info only.
    priority: medium
    parallel_group: 4
    completed: true
    verification: |
      grep -q 'isLuminanceReduced' ClaudeWatch/Views/ -r
    acceptance_criteria:
      - "Simplified UI in always-on mode"
      - "No bright colors or animations"
      - "Connection status always visible"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Complications/ComplicationViews.swift"
    tags:
      - always-on
      - hig
      - battery
    commit_template: "feat(display): Add Always-On Display support"
  - id: "M3"
    title: "Add Dynamic Type support"
    description: |
      Use .dynamicTypeSize environment and prefer semantic fonts.
      Test with all accessibility sizes.
      Use @ScaledMetric for custom sizes.
    priority: medium
    parallel_group: 4
    completed: true
    verification: |
      grep -q 'dynamicTypeSize\|@ScaledMetric\|DynamicType' ClaudeWatch/Views/ -r
    acceptance_criteria:
      - "Text scales with system setting"
      - "Layout adapts to larger sizes"
      - "No text truncation at largest size"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Views/SettingsView.swift"
    tags:
      - accessibility
      - typography
      - hig
    commit_template: "feat(a11y): Add Dynamic Type support"
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 4: WATCHOS 26 / LIQUID GLASS
  # Parallel Group 5: Can run concurrently
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "LG1"
    title: "Adopt Liquid Glass materials"
    description: |
      Replace .opacity() backgrounds with .ultraThinMaterial or .thinMaterial.
      Update to translucent, depth-aware UI components using SwiftUI's
      built-in Material types (.ultraThinMaterial, .thinMaterial, .regularMaterial).
      These provide the glass-like effect available in watchOS 10+.
    priority: medium
    parallel_group: 5
    completed: true
    verification: |
      grep -qE 'ultraThinMaterial|thinMaterial|regularMaterial|\.background\(\..*Material' ClaudeWatch/Views/ -r
    acceptance_criteria:
      - "Material backgrounds on primary containers"
      - "Uses SwiftUI Material types (ultraThinMaterial, thinMaterial, etc.)"
      - "Maintains readability"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Views/Components/"
    tags:
      - liquid-glass
      - watchos26
      - design
    commit_template: "feat(design): Adopt Liquid Glass materials"
  - id: "LG2"
    title: "Add spring animations"
    description: |
      Replace linear animations with .spring() for natural feel.
      Use .animation(.bouncy) or .interpolatingSpring() for interactive elements.
      Spring animations make UI feel more responsive and natural.
    priority: low
    parallel_group: 5
    completed: true
    verification: |
      grep -qE '\.spring\(|interpolatingSpring|animation\(\.bouncy|\.bouncy\)' ClaudeWatch/Views/ -r
    acceptance_criteria:
      - "Buttons use spring animations"
      - "Transitions feel natural"
      - "No jarring or abrupt motion"
    files:
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - animation
      - liquid-glass
      - hig
    commit_template: "feat(animation): Add spring animations"
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 5: TESTING & DOCUMENTATION
  # Parallel Group 6
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "T1"
    title: "Add UI tests for critical flows"
    description: |
      Create XCUITest cases for:
      - App launch and consent flow
      - Connection status display
      - Approval/rejection actions
      - Settings navigation
      Note: Tests should be added to ClaudeWatch/Tests/ directory.
    priority: medium
    parallel_group: 6
    completed: true
    verification: |
      ls ClaudeWatch/Tests/UI*.swift 2>/dev/null | wc -l | grep -q '[1-9]'
    acceptance_criteria:
      - "UI tests for main user flows"
      - "Tests pass on simulator"
      - "Good coverage of critical paths"
    files:
      - "ClaudeWatch/Tests/"
    tags:
      - testing
      - quality
    commit_template: "test(ui): Add UI tests for critical flows"

  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 6: SEAMLESS PAIRING - Reduce pairing friction
  # Parallel Group 7: Can run concurrently
  # Spec: docs/specs/SEAMLESS_PAIRING_SPEC.md
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "SP1"
    title: "Add clipboard paste button for pairing"
    description: |
      Add a "Paste Code" button to PairingView that reads the pairing code
      from Universal Clipboard. This allows users to copy the code on their
      Mac/iPhone and paste on the watch with one tap instead of typing.

      Implementation:
      1. Add "Paste Code" button below the text field
      2. On tap, read from UIPasteboard.general.string
      3. Parse clipboard for code pattern matching [A-Z0-9]{3}-[A-Z0-9]{3}
      4. If valid code found, populate the text field and auto-submit
      5. If no valid code, show brief error message
      6. Add haptic feedback (.success or .failure)

      Note: watchOS uses the same UIPasteboard API as iOS via WatchKit.
      Universal Clipboard works when devices are on same iCloud account,
      nearby, and have Bluetooth/WiFi enabled.
    priority: high
    parallel_group: 7
    completed: false
    verification: |
      grep -qE 'UIPasteboard|Pasteboard|pasteCode|clipboardCode|Paste.*Code' ClaudeWatch/Views/PairingView.swift && exit 0 || exit 1
    acceptance_criteria:
      - "Paste Code button visible below text input"
      - "Reads from Universal Clipboard on tap"
      - "Parses and validates code format"
      - "Auto-fills text field with valid code"
      - "Shows error if clipboard empty or invalid"
      - "Haptic feedback on success/failure"
      - "Accessibility label on button"
    files:
      - "ClaudeWatch/Views/PairingView.swift"
    tags:
      - pairing
      - ux
      - clipboard
    commit_template: "feat(pairing): Add clipboard paste button for seamless pairing"

  - id: "SP2"
    title: "Add numeric-only pairing code input option"
    description: |
      Add support for numeric-only pairing codes (6 digits like "123456")
      alongside the existing alphanumeric format. Numeric codes are faster
      to type on the watch's number pad.

      Implementation:
      1. Detect if code contains only digits (6-digit format)
      2. If numeric, use .numberPad keyboard type for faster input
      3. Update code validation to accept both formats:
         - Alphanumeric: ABC-123 (7 chars with hyphen)
         - Numeric: 123456 (6 digits, no hyphen)
      4. Auto-format: don't add hyphen for numeric codes
      5. Both formats should work with existing server endpoints

      The server already normalizes codes, so this is primarily a UX change
      on the watch side to support faster numeric input.
    priority: high
    parallel_group: 7
    completed: false
    verification: |
      grep -qE 'numberPad|decimalPad|isNumericCode|numericFormat' ClaudeWatch/Views/PairingView.swift && exit 0 || exit 1
    acceptance_criteria:
      - "Detects numeric-only codes"
      - "Uses number pad keyboard for numeric codes"
      - "Accepts 6-digit codes without hyphen"
      - "Maintains support for ABC-123 format"
      - "Validation works for both formats"
    files:
      - "ClaudeWatch/Views/PairingView.swift"
    tags:
      - pairing
      - ux
      - keyboard
    commit_template: "feat(pairing): Add numeric code input for faster pairing"

  - id: "SP3"
    title: "Add deep link URL scheme support for pairing"
    description: |
      Register claude-watch:// URL scheme to enable deep linking directly
      into the pairing flow with a pre-filled code.

      Implementation:
      1. Add URL scheme to Info.plist:
         - CFBundleURLTypes with CFBundleURLSchemes: ["claude-watch"]
      2. Handle .onOpenURL in ClaudeWatchApp.swift
      3. Parse URL: claude-watch://pair?code=ABC123
      4. Extract code from query parameters
      5. Navigate to PairingView with code pre-filled
      6. Store pending code in @State or environment

      URL format examples:
      - claude-watch://pair?code=ABC-123
      - claude-watch://pair?code=123456

      This enables future integrations like:
      - Clickable links in terminal
      - QR codes that open the app
      - Web-based pairing flows
    priority: medium
    parallel_group: 7
    completed: false
    verification: |
      grep -q 'onOpenURL' ClaudeWatch/App/ClaudeWatchApp.swift && \
      grep -qE 'CFBundleURLSchemes|claude-watch' ClaudeWatch/Info.plist && exit 0 || exit 1
    acceptance_criteria:
      - "URL scheme registered in Info.plist"
      - "App handles onOpenURL modifier"
      - "Parses code from URL query string"
      - "Pre-fills code in PairingView"
      - "Works with both code formats"
      - "Handles invalid/missing code gracefully"
    files:
      - "ClaudeWatch/App/ClaudeWatchApp.swift"
      - "ClaudeWatch/Info.plist"
    tags:
      - pairing
      - deep-links
      - url-scheme
    commit_template: "feat(pairing): Add deep link URL scheme support"

  - id: "SP4"
    title: "Add server-side numeric code generation"
    description: |
      Update the Cloudflare Worker to support generating numeric-only
      pairing codes as an alternative to alphanumeric codes.

      Implementation:
      1. Add optional ?format=numeric query param to POST /pair endpoint
      2. If format=numeric, generate 6-digit code (100000-999999)
      3. If format not specified, keep current ABC-123 format
      4. Store numeric codes the same way in KV
      5. Lookup should work for both formats (already case-insensitive)

      The numeric format is optional to maintain backwards compatibility.
      Claude Code CLI can choose which format to request.

      Code format:
      - Default: "ABC-123" (6 chars from ABCDEFGHJKLMNPQRSTUVWXYZ23456789)
      - Numeric: "123456" (6 digits from 0-9)
    priority: medium
    parallel_group: 7
    completed: false
    verification: |
      grep -qE 'format.*numeric|numericCode|generateNumeric' MCPServer/worker/src/index.js && exit 0 || exit 1
    acceptance_criteria:
      - "POST /pair accepts ?format=numeric query param"
      - "Generates 6-digit numeric codes when requested"
      - "Default format unchanged (ABC-123)"
      - "Numeric codes stored and retrieved correctly"
      - "Documentation updated in API"
    files:
      - "MCPServer/worker/src/index.js"
    tags:
      - pairing
      - server
      - api
    commit_template: "feat(api): Add numeric pairing code generation"

  - id: "SP5"
    title: "Add pairing code scannability via QR display hint"
    description: |
      When Claude Code displays the pairing code in terminal, also provide
      a hint about the QR code URL that can be used for future scanning.

      Implementation:
      1. Update server response to include a qrUrl field:
         { code: "ABC-123", qrUrl: "claude-watch://pair?code=ABC-123", ... }
      2. This URL can be:
         - Converted to QR code by CLI tools
         - Clicked if terminal supports hyperlinks
         - Scanned by future iOS companion app

      This is a preparatory step for Phase 2 (iOS companion app with
      QR scanning). The watch app doesn't need to change for this task.
    priority: low
    parallel_group: 7
    completed: false
    verification: |
      grep -qE 'qrUrl|deepLink|pairingUrl' MCPServer/worker/src/index.js && exit 0 || exit 1
    acceptance_criteria:
      - "POST /pair response includes qrUrl field"
      - "qrUrl contains claude-watch://pair?code=..."
      - "URL is properly encoded"
      - "Backwards compatible (qrUrl is optional field)"
    files:
      - "MCPServer/worker/src/index.js"
    tags:
      - pairing
      - server
      - qr-code
    commit_template: "feat(api): Add QR-scannable deep link URL to pairing response"
