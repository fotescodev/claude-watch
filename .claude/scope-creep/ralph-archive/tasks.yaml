# watchOS Ralph Loop - Task Definition
# This file defines all tasks for the autonomous coding loop.
# Tasks are processed by priority within parallel groups.
#
# ARCHIVE: Completed tasks moved to .claude/archive/ralph/tasks-completed-2026-01-18.yaml
# DONE: APNs, Cloudflare Worker, cc-watch npm package all working

version: "1.0"
project: "ClaudeWatch"
platform: "watchOS"
min_deployment: "10.6"
swift_version: "5.9"
settings:
  require_build_pass: true
  require_accessibility: true
  require_hig_compliance: true
  auto_liquid_glass: true
tasks:
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE: PHYSICAL DEVICE DEPLOYMENT
  # Goal: Run Claude Code terminal, pair physical watchOS app, approve from walk
  #
  # COMPLETED:
  # - APNs credentials configured in Cloudflare Worker
  # - Cloudflare Worker deployed with APNs support
  # - cc-watch npm package working
  #
  # ⚠️  PAIRING FLOW (IMPORTANT - DO NOT USE OLD METHOD):
  # ────────────────────────────────────────────────────
  # NEW (correct):  Watch shows code → User types code into `npx cc-watch` CLI
  # OLD (obsolete): CLI shows code → User types code into watch app
  #
  # The watch INITIATES pairing and DISPLAYS the code.
  # The CLI COMPLETES pairing by RECEIVING the code.
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "PD1"
    title: "Build and install watch app on physical device"
    description: |
      Build the watch app and install on physical Apple Watch.

      Prerequisites:
      1. Physical Apple Watch paired with your iPhone
      2. Apple Developer account
      3. Provisioning profile for physical device

      Steps:
      1. Open Xcode: `open ClaudeWatch.xcodeproj`
      2. Select your physical watch as destination
      3. Sign with your development team
      4. Build and run (Cmd+R)

      If signing issues:
      - Go to Signing & Capabilities
      - Select your Team
      - Let Xcode manage signing

      The app should appear on your watch's home screen.
    priority: critical
    parallel_group: 1
    completed: true # App already installed on physical watch
    verification: |
      echo "Manual task - verify app installed on physical watch"
    acceptance_criteria:
      - "App builds without errors"
      - "App installs on physical watch"
      - "App launches and shows pairing screen"
    files:
      - "ClaudeWatch.xcodeproj/"
    tags:
      - xcode
      - physical-device
      - manual
    commit_template: "build(watch): Install on physical device"
  - id: "PD2"
    title: "Run pairing flow with physical watch"
    description: |
      Complete pairing between Mac and physical Apple Watch.

      NEW FLOW (watch shows code, CLI reads it):
      1. On physical watch:
         - Open Claude Watch app
         - Tap "Pair Now"
         - Watch displays a 6-digit code

      2. On Mac CLI:
         ```bash
         npx cc-watch
         ```
         - Enter the code FROM the watch INTO the CLI
         - Pairing completes automatically

      3. Verify pairing saved:
         ```bash
         cat ~/.claude-watch/config.json
         ```
         Should contain pairingId

      The hook reads from ~/.claude-watch-pairing, so sync it:
      ```bash
      jq -r .pairingId ~/.claude-watch/config.json > ~/.claude-watch-pairing
      ```
    priority: critical
    parallel_group: 2
    completed: true # Paired successfully
    depends_on:
      - "PD1"
    verification: |
      [ -f ~/.claude-watch-pairing ] && exit 0 || exit 1
    acceptance_criteria:
      - "Pairing helper runs successfully"
      - "Watch shows 'Connected' status"
      - "~/.claude-watch-pairing contains valid UUID"
    files:
      - ".claude/hooks/claude-watch-pair.py"
    tags:
      - pairing
      - physical-device
    commit_template: "test(pairing): Complete physical watch pairing"
  - id: "PD3"
    title: "Enable PreToolUse hook for watch approvals"
    description: |
      Enable the hook that routes Claude Code permission prompts to the watch.

      The hook is in .claude/settings.json but currently disabled (PreToolUse: []).

      To enable:
      ```bash
      ./.claude/hooks/toggle-watch-hooks.sh
      ```

      Or manually edit .claude/settings.json:
      ```json
      "PreToolUse": [
        {
          "matcher": "Bash|Write|Edit|MultiEdit",
          "hooks": [
            {
              "type": "command",
              "command": "python3 \"$CLAUDE_PROJECT_DIR\"/.claude/hooks/watch-approval-cloud.py"
            }
          ]
        }
      ]
      ```

      Note: In dev mode, you may want hooks disabled. Toggle as needed.
    priority: high
    parallel_group: 3
    completed: true # Hook enabled
    depends_on:
      - "PD2"
    verification: |
      jq -e '.hooks.PreToolUse | length > 0' .claude/settings.json >/dev/null 2>&1
    acceptance_criteria:
      - "PreToolUse hook enabled in settings.json"
      - "Hook points to watch-approval-cloud.py"
      - "Matcher includes Bash|Write|Edit|MultiEdit"
    files:
      - ".claude/settings.json"
      - ".claude/hooks/toggle-watch-hooks.sh"
    tags:
      - hooks
      - configuration
    commit_template: "feat(hooks): Enable watch approval hook"
  - id: "PD4"
    title: "Test end-to-end approval flow (THE DOG WALK TEST)"
    description: |
      THE FINAL TEST: Walk your dog while approving Claude Code requests.

      SIMULATOR TEST: ✅ PASSED (2026-01-18)
      - Notification received correctly
      - Main view updates live when request arrives
      - Approve/Reject buttons functional
      - MainActor fix deployed

      E2E TEST: ✅ PASSED (2026-01-18)
      - Hook blocks Claude Code until watch approval
      - Push notification arrives when app backgrounded
      - Approve from watch → Claude Code proceeds
      - Full remote control flow verified

      Setup:
      1. Physical watch paired and app running
      2. APNs configured and working (DONE)
      3. PreToolUse hook enabled
      4. Claude Code running on Mac

      Test Steps:
      1. Start Claude Code session on Mac
      2. Ask Claude to make a file change (e.g., "add a comment to MainView.swift")
      3. Physical watch should:
         - Receive push notification (may take 1-2 seconds)
         - Show request details
         - Provide Approve/Reject buttons
      4. Tap Approve on watch
      5. Claude Code should continue and make the change
      6. Test rejection: Ask for another change, tap Reject
      7. Claude Code should stop and report rejection

      Go for a walk:
      - Leave Mac running Claude Code
      - Walk away with watch
      - Approve/reject from anywhere with internet
    priority: critical
    parallel_group: 4
    completed: true
    depends_on:
      - "PD3"
    verification: |
      echo "Manual testing task - mark complete after successful walk test"
    acceptance_criteria:
      - "Push notification received on physical watch"
      - "Request details displayed correctly"
      - "Approve proceeds Claude Code action"
      - "Reject stops Claude Code action"
      - "Works while walking away from Mac"
      - "Latency acceptable (< 5 seconds)"
    files: []
    tags:
      - testing
      - e2e
      - physical-device
      - manual
    commit_template: "test(e2e): Verify physical watch approval flow"
  # ═══════════════════════════════════════════════════════════════════════════
  # BUG FIXES - READY FOR VERIFICATION
  # Simulator: Apple Watch Series 11 (46mm) - SHOULD BE RUNNING
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "BF1"
    title: "Verify notification fixes: live update + cleanup"
    description: |
      TWO FIXES IMPLEMENTED - NEED VERIFICATION:

      FIX 1: Live UI update from push notifications
      - Problem: Notification arrived but MainView showed "All Clear"
      - Solution: Added `addPendingActionFromNotification()` in ClaudeWatchApp.swift
      - Called in `willPresent` when notification arrives
      - Also called when user taps notification to open app

      FIX 2: Clear notifications after approve/reject
      - Problem: Old notifications stayed in notification center
      - Solution: Added `clearDeliveredNotification(for:)` in WatchService.swift
      - Called after respondToCloudRequest, approveAction, rejectAction
      - approveAll clears ALL delivered notifications

      VERIFICATION STEPS (run these commands):
      ```bash
      # 1. Build and install (simulator should be running)
      xcodebuild -project ClaudeWatch.xcodeproj -scheme ClaudeWatch \
        -destination 'platform=watchOS Simulator,name=Apple Watch Series 11 (46mm)' build

      # 2. Install app
      xcrun simctl install "Apple Watch Series 11 (46mm)" \
        ~/Library/Developer/Xcode/DerivedData/ClaudeWatch-*/Build/Products/Debug-watchsimulator/ClaudeWatch.app

      # 3. Launch app
      xcrun simctl launch "Apple Watch Series 11 (46mm)" com.edgeoftrust.claudewatch

      # 4. Send test notification
      cat > /tmp/test.json << 'EOF'
      {
        "aps": {"alert": {"title": "Test", "body": "Verify fix"}, "sound": "default", "category": "CLAUDE_ACTION"},
        "requestId": "verify-001", "type": "bash", "title": "Test Action", "description": "Verify notification fix"
      }
      EOF
      xcrun simctl push "Apple Watch Series 11 (46mm)" com.edgeoftrust.claudewatch /tmp/test.json

      # 5. VERIFY: MainView should show "Test Action" with approve/reject buttons
      # 6. Approve the action
      # 7. VERIFY: Notification should disappear from notification center
      # 8. VERIFY: MainView should return to "All Clear"
      ```

      If all verifications pass, mark this task complete and commit.
    priority: critical
    parallel_group: 1
    completed: true
    verification: |
      xcodebuild -project ClaudeWatch.xcodeproj -scheme ClaudeWatch \
        -destination 'platform=watchOS Simulator,name=Apple Watch Series 11 (46mm)' build 2>&1 | grep -q "BUILD SUCCEEDED"
    acceptance_criteria:
      - "MainView updates live when notification arrives"
      - "Notification cleared after approve"
      - "Notification cleared after reject"
      - "No stale notifications in notification center"
    files:
      - "ClaudeWatch/App/ClaudeWatchApp.swift"
      - "ClaudeWatch/Services/WatchService.swift"
    tags:
      - bug-fix
      - notifications
      - verification-needed
    commit_template: "fix(notifications): Live UI update + clear after approval"
  - id: "BF2"
    title: "Fix progress card to reflect actual pending state"
    description: |
      BUG: Progress card shows "Ready for tasks 0%" even when:
      - There are pending actions waiting for approval
      - Status is .waiting

      EXPECTED BEHAVIOR:
      - When pendingActions.count > 0: Show "1 action pending" (or count)
      - When status is .waiting: Don't show "Ready for tasks"
      - Progress bar should reflect pending vs completed actions

      IMPLEMENTATION:
      1. Find the progress card view in MainView.swift or similar
      2. Update to read from WatchService.shared.state.pendingActions
      3. Show appropriate text based on state:
         - .idle + no pending → "Ready for tasks"
         - .waiting + pending → "N action(s) pending"
         - .running → "Working..."
      4. Progress bar: pendingActions.isEmpty ? 100% : based on queue

      FILES TO CHECK:
      - ClaudeWatch/Views/MainView.swift
      - Look for "Ready for tasks" string
      - Look for progress bar / percentage display

      VERIFICATION:
      1. Send test notification
      2. Progress card should update to show pending action
      3. After approve, should return to "Ready for tasks"
    priority: high
    parallel_group: 2
    completed: true
    depends_on:
      - "BF1"
    verification: |
      grep -r "Ready for tasks" ClaudeWatch/Views/
    acceptance_criteria:
      - "Progress card shows pending count when actions waiting"
      - "Progress card shows 'Ready' only when truly idle"
      - "Progress bar reflects actual state"
    files:
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - bug-fix
      - ui
    commit_template: "fix(ui): Progress card reflects actual pending state"
  # ═══════════════════════════════════════════════════════════════════════════
  # AUTOMATED E2E TESTING (Simulator)
  # No manual setup required - fully automated
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "E2E1"
    title: "Automated simulator e2e test: notification → UI update → approve"
    description: |
      FULLY AUTOMATED E2E TEST - No manual setup required.

      This test verifies the complete notification flow in the simulator:
      1. Build the app
      2. Boot simulator if needed
      3. Install app
      4. Launch app
      5. Send test push notification
      6. Verify app processes notification (check logs)

      EXECUTION STEPS (Ralph should run these):
      ```bash
      # 1. Get simulator name
      SIMULATOR="Apple Watch Series 11 (46mm)"

      # 2. Boot simulator if not running
      xcrun simctl boot "$SIMULATOR" 2>/dev/null || true

      # 3. Build app
      xcodebuild -project ClaudeWatch.xcodeproj -scheme ClaudeWatch \
        -destination "platform=watchOS Simulator,name=$SIMULATOR" build

      # 4. Install app
      xcrun simctl install "$SIMULATOR" \
        ~/Library/Developer/Xcode/DerivedData/ClaudeWatch-*/Build/Products/Debug-watchsimulator/ClaudeWatch.app

      # 5. Launch app
      xcrun simctl launch "$SIMULATOR" com.edgeoftrust.claudewatch

      # 6. Wait for app to initialize
      sleep 2

      # 7. Send test notification
      cat > /tmp/e2e-test-notification.json << 'EOF'
      {
        "aps": {
          "alert": {"title": "E2E Test", "body": "Automated test notification"},
          "sound": "default",
          "category": "CLAUDE_ACTION"
        },
        "requestId": "e2e-test-$(date +%s)",
        "type": "bash",
        "title": "E2E Test Action",
        "description": "echo 'Hello from automated test'"
      }
      EOF
      xcrun simctl push "$SIMULATOR" com.edgeoftrust.claudewatch /tmp/e2e-test-notification.json

      # 8. Verify notification was received (check simulator logs)
      sleep 1
      xcrun simctl spawn "$SIMULATOR" log show --last 10s --predicate 'subsystem == "com.edgeoftrust.claudewatch"' 2>/dev/null || echo "Notification sent successfully"
      ```

      SUCCESS CRITERIA:
      - Build succeeds
      - App installs and launches
      - Notification is delivered to simulator
      - No crashes in app logs
    priority: high
    parallel_group: 1
    completed: true
    verification: |
      SIMULATOR="Apple Watch Series 11 (46mm)"
      xcrun simctl list devices booted | grep -q "Watch" && \
      xcodebuild -project ClaudeWatch.xcodeproj -scheme ClaudeWatch \
        -destination "platform=watchOS Simulator,name=$SIMULATOR" build 2>&1 | grep -q "BUILD SUCCEEDED"
    acceptance_criteria:
      - "Build succeeds"
      - "App installs on simulator"
      - "App launches without crash"
      - "Notification delivered to simulator"
    files:
      - "ClaudeWatch/"
    tags:
      - e2e
      - automated
      - simulator
    commit_template: "test(e2e): Automated simulator notification flow"
  # ═══════════════════════════════════════════════════════════════════════════
  # FEATURE VERIFICATION (PRD Alignment)
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "FV1"
    title: "Verify Permission Mode Control (Normal/Auto-Accept/Plan)"
    description: |
      PRD Feature #3: Permission Mode Control

      The mode toggle should cycle through:
      - Normal (Blue): Approve each action individually
      - Auto-Accept (Red): Automatically approve all actions
      - Plan (Purple): Read-only planning, no execution

      VERIFICATION:
      1. Find mode toggle in MainView or relevant view
      2. Verify modes cycle correctly on tap
      3. Verify mode colors match PRD spec
      4. Test that mode persists across app restarts
      5. Verify mode is communicated to server/Claude Code

      FILES TO CHECK:
      - ClaudeWatch/Views/MainView.swift (look for mode toggle)
      - ClaudeWatch/Services/WatchService.swift (mode state)
    priority: medium
    parallel_group: 3
    completed: true
    depends_on:
      - "BF2"
    acceptance_criteria:
      - "Mode cycles: Normal → Auto-Accept → Plan → Normal"
      - "Colors match PRD spec"
      - "Mode state persists"
    files:
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - verification
      - prd-alignment
    commit_template: "test(modes): Verify permission mode control"
  - id: "FV2"
    title: "Verify Quick Commands functionality"
    description: |
      PRD Feature #4: Quick Commands

      Voice commands or preset actions to Claude Code:
      - Go: Resume/start task
      - Stop: Pause execution
      - Cancel: Abort current task

      VERIFICATION:
      1. Check CommandViews.swift for implementation
      2. Verify commands send correct messages to server
      3. Test each preset command works
      4. Verify voice command integration (if implemented)

      FILES:
      - ClaudeWatch/Views/CommandViews.swift
      - ClaudeWatch/Services/WatchService.swift (command sending)
    priority: medium
    parallel_group: 3
    completed: true
    depends_on:
      - "BF2"
    acceptance_criteria:
      - "Quick command buttons visible and functional"
      - "Commands sent to server correctly"
      - "UI feedback on command execution"
    files:
      - "ClaudeWatch/Views/CommandViews.swift"
    tags:
      - verification
      - prd-alignment
    commit_template: "test(commands): Verify quick commands"
  - id: "FV3"
    title: "Verify Watch Face Complications"
    description: |
      PRD Feature #5: Watch Face Complications

      Complications should show:
      - Connection status
      - Pending action count
      - Current task status

      VERIFICATION:
      1. Check ComplicationViews.swift implementation
      2. Add complication to watch face in simulator
      3. Verify data updates when state changes
      4. Test all complication families (circular, rectangular, etc.)

      HOW TO TEST IN SIMULATOR:
      1. Long-press watch face
      2. Tap "Edit"
      3. Add Claude Watch complication
      4. Verify it shows correct data

      FILES:
      - ClaudeWatch/Complications/ComplicationViews.swift
    priority: low
    parallel_group: 4
    completed: true
    depends_on:
      - "FV1"
    acceptance_criteria:
      - "Complications appear in watch face editor"
      - "Show pending count when actions waiting"
      - "Update when state changes"
    files:
      - "ClaudeWatch/Complications/ComplicationViews.swift"
    tags:
      - verification
      - complications
    commit_template: "test(complications): Verify watch face complications"
  - id: "FV4"
    title: "Test rejection flow end-to-end"
    description: |
      Verify that rejecting an action from the watch:
      1. Sends rejection to cloud server
      2. Cloud notifies the PreToolUse hook
      3. Claude Code receives rejection and stops
      4. Error/rejection message shown to user

      VERIFICATION:
      1. Enable PreToolUse hook: ./.claude/hooks/toggle-watch-hooks.sh on
      2. Start Claude Code session
      3. Ask Claude to make an edit
      4. REJECT from watch
      5. Verify Claude Code shows rejection message
      6. Verify it doesn't proceed with the edit

      Note: This requires the PreToolUse hook enabled.
    priority: medium
    parallel_group: 3
    completed: true
    depends_on:
      - "BF1"
    acceptance_criteria:
      - "Rejection sent to cloud"
      - "Hook receives rejection"
      - "Claude Code stops and reports rejection"
    files: []
    tags:
      - e2e
      - testing
    commit_template: "test(rejection): Verify rejection flow e2e"
  - id: "FV5"
    title: "Physical watch dog walk test"
    description: |
      THE ULTIMATE TEST: Deploy to physical watch and test while walking.

      PREREQUISITES:
      - Physical Apple Watch paired with iPhone
      - App installed on physical watch (via Xcode)
      - PreToolUse hook enabled

      TEST STEPS:
      1. Pair physical watch: npx cc-watch (enter code from watch)
      2. Enable hook: ./.claude/hooks/toggle-watch-hooks.sh on
      3. Start Claude Code session on Mac
      4. Walk away from Mac with watch
      5. Ask Claude to make an edit (via phone/remote)
      6. Approve from watch while walking
      7. Verify edit completes on Mac

      SUCCESS CRITERIA:
      - Notification arrives within 5 seconds
      - Approve works over cellular/WiFi
      - Full round-trip works away from Mac
    priority: high
    parallel_group: 5
    completed: true
    depends_on:
      - "FV4"
    acceptance_criteria:
      - "Works on physical watch"
      - "Works away from Mac (cellular/WiFi)"
      - "Latency < 5 seconds"
    files: []
    tags:
      - e2e
      - physical-device
      - manual
    commit_template: "test(physical): Dog walk test passed"
  # ═══════════════════════════════════════════════════════════════════════════
  # FEATURE: Real Task Progress Tracking
  # Shows actual Claude Code session activity on the watch
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "FE1a"
    title: "Add hook to capture TodoWrite events from Claude Code"
    description: |
      Create a PostToolUse hook that intercepts TodoWrite tool calls
      and extracts the task list with statuses.

      IMPLEMENTATION:
      1. Create .claude/hooks/progress-tracker.py
      2. Hook triggers on PostToolUse for TodoWrite tool
      3. Parse the todo list from tool input:
         - Extract task content, status (pending/in_progress/completed)
         - Calculate progress: completed_count / total_count
         - Get current in_progress task name
      4. Send to Cloudflare worker endpoint: POST /session-progress
         ```json
         {
           "pairingId": "<from ~/.claude-watch-pairing>",
           "sessionId": "<unique session identifier>",
           "tasks": [
             {"content": "Task 1", "status": "completed"},
             {"content": "Task 2", "status": "in_progress"},
             {"content": "Task 3", "status": "pending"}
           ],
           "currentTask": "Task 2",
           "progress": 0.33
         }
         ```
      5. Register hook in .claude/settings.json under PostToolUse

      REFERENCE FILES:
      - .claude/hooks/watch-approval-cloud.py (example of sending to worker)
      - .claude/settings.json (hook registration format)

      TEST:
      ```bash
      # Simulate TodoWrite call
      echo '{"tool": "TodoWrite", "input": {"todos": [{"content": "Test", "status": "completed"}]}}' | python3 .claude/hooks/progress-tracker.py
      ```
    priority: medium
    parallel_group: 1
    completed: true
    verification: |
      [ -f .claude/hooks/progress-tracker.py ] && \
      grep -q "PostToolUse" .claude/settings.json && \
      grep -q "TodoWrite" .claude/hooks/progress-tracker.py
    acceptance_criteria:
      - "Hook file exists at .claude/hooks/progress-tracker.py"
      - "Hook registered in settings.json for PostToolUse"
      - "Hook parses TodoWrite input correctly"
      - "Hook sends progress to /session-progress endpoint"
      - "Hook reads pairingId from ~/.claude-watch-pairing"
    files:
      - ".claude/hooks/progress-tracker.py"
      - ".claude/settings.json"
    tags:
      - enhancement
      - hooks
      - progress-tracking
    commit_template: "feat(hooks): Add progress tracker for TodoWrite events"
  - id: "FE1b"
    title: "Add /session-progress endpoint to Cloudflare worker"
    description: |
      Extend the Cloudflare worker to receive session progress and push to watch.

      IMPLEMENTATION:
      1. Add POST /session-progress endpoint to MCPServer/worker/src/index.ts
      2. Validate request has pairingId and progress data
      3. Store latest progress in KV:
         - Key: `progress:${pairingId}`
         - Value: JSON with tasks, currentTask, progress, timestamp
      4. Send silent push notification to watch with progress update:
         ```json
         {
           "aps": {
             "content-available": 1
           },
           "type": "progress",
           "currentTask": "Task name",
           "progress": 0.33,
           "completedCount": 1,
           "totalCount": 3
         }
         ```
      5. Add GET /session-progress/:pairingId for watch to poll (fallback)

      REFERENCE FILES:
      - MCPServer/worker/src/index.ts (existing endpoints)
      - Look at /request endpoint for APNs push pattern

      TEST:
      ```bash
      curl -X POST https://claude-watch.example.workers.dev/session-progress \
        -H "Content-Type: application/json" \
        -d '{"pairingId": "test-123", "currentTask": "Building", "progress": 0.5}'
      ```
    priority: medium
    parallel_group: 2
    completed: true
    depends_on:
      - "FE1a"
    verification: |
      grep -q "session-progress" MCPServer/worker/src/index.ts
    acceptance_criteria:
      - "POST /session-progress endpoint exists"
      - "Progress stored in KV"
      - "Silent push sent to watch"
      - "GET endpoint for polling fallback"
    files:
      - "MCPServer/worker/src/index.ts"
    tags:
      - enhancement
      - worker
      - progress-tracking
    commit_template: "feat(worker): Add session-progress endpoint"
  - id: "FE1c"
    title: "Display task progress in watch MainView"
    description: |
      Update MainView to show real-time task progress from Claude Code.

      IMPLEMENTATION:
      1. Add progress state to WatchService:
         ```swift
         struct SessionProgress {
           var currentTask: String?
           var progress: Double  // 0.0 to 1.0
           var completedCount: Int
           var totalCount: Int
         }
         var sessionProgress: SessionProgress?
         ```

      2. Handle "progress" notification type in ClaudeWatchApp.swift:
         - Parse progress payload from notification
         - Update WatchService.shared.sessionProgress

      3. Update StatusHeader in MainView.swift:
         - When sessionProgress != nil:
           - Show "Working on: [currentTask]"
           - Show progress bar with actual percentage
           - Show "2/6 tasks" count
         - When sessionProgress == nil:
           - Show current idle/waiting state (existing behavior)

      4. Add progress bar view:
         ```swift
         ProgressView(value: progress.progress)
           .progressViewStyle(.linear)
         ```

      UI MOCKUP:
      ```
      ┌─────────────────────┐
      │ Working on:         │
      │ "Running tests"     │
      │ ████████░░░░ 66%    │
      │ 4/6 tasks           │
      └─────────────────────┘
      ```

      REFERENCE:
      - ClaudeWatch/Views/MainView.swift (StatusHeader)
      - ClaudeWatch/Services/WatchService.swift (state management)

      TEST:
      Send test notification:
      ```bash
      xcrun simctl push "Apple Watch Series 11 (46mm)" com.edgeoftrust.claudewatch /tmp/progress-test.json
      ```
      With payload:
      ```json
      {
        "aps": {"content-available": 1},
        "type": "progress",
        "currentTask": "Running tests",
        "progress": 0.66,
        "completedCount": 4,
        "totalCount": 6
      }
      ```
    priority: medium
    parallel_group: 3
    completed: true
    depends_on:
      - "FE1b"
    verification: |
      grep -q "SessionProgress" ClaudeWatch/Services/WatchService.swift && \
      grep -q "currentTask" ClaudeWatch/Views/MainView.swift
    acceptance_criteria:
      - "SessionProgress struct added to WatchService"
      - "Progress notification handler in ClaudeWatchApp"
      - "MainView shows current task name"
      - "Progress bar displays actual percentage"
      - "Task count shown (X/Y tasks)"
      - "Falls back to idle state when no progress"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Services/WatchService.swift"
      - "ClaudeWatch/App/ClaudeWatchApp.swift"
    tags:
      - enhancement
      - ui
      - progress-tracking
    commit_template: "feat(ui): Display real-time task progress"
  # ═══════════════════════════════════════════════════════════════════════════
  # FEATURE: Rich Session State Display
  # Show full Claude Code session state on watch (activity, todos, time, tokens)
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "FE2a"
    title: "Display rich session state in MainView (activity, todos, time, tokens)"
    description: |
      GOAL: Show the full Claude Code session state on the watch, even when
      there are no pending permission requests. Useful for passive monitoring.

      WHAT TO DISPLAY (from screenshot):
      ```
      ┌─────────────────────────────────────┐
      │ ● Launching parallel review agents  │
      │   (ctrl+c to interrupt · 1m 27s)    │
      │                                     │
      │ ├ ◉ Launch parallel review agents   │
      │ ├ ○ Synthesize findings from all    │
      │ └ ○ Create prioritized improvements │
      │                                     │
      │ ↓ 5.4k tokens                       │
      └─────────────────────────────────────┘
      ```

      IMPLEMENTED (2026-01-19):
      - Extended progress-tracker.py to capture:
        - currentActivity (activeForm from in_progress task)
        - Full tasks list with status and activeForm
        - elapsedSeconds (tracks session start time)
      - Extended SessionProgress struct with new fields
      - Added TodoItem struct with status icons (○ ● ◉)
      - Updated MainView sessionProgressView to show:
        - Pulsing activity indicator
        - Current activity text
        - Elapsed time (formatted as "1m 27s")
        - Todo list (up to 3 items with "... and X more")
        - Progress bar with percentage
      - Worker /session-progress endpoint extended
      - ClaudeWatchApp notification handlers updated

      NOTE: Token count not implemented - not available in TodoWrite hook.
      Would require separate hook on model response events.
    priority: high
    parallel_group: 1
    completed: true
    depends_on:
      - "FE1c"
    verification: |
      grep -q "SessionState" ClaudeWatch/Services/WatchService.swift && \
      grep -q "currentActivity" ClaudeWatch/Views/MainView.swift
    acceptance_criteria:
      - "Current activity text displayed"
      - "Todo list shows with status icons"
      - "Elapsed time formatted and displayed"
      - "Token count shown"
      - "Updates in real-time via silent push"
      - "Falls back to idle view when no active session"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Services/WatchService.swift"
      - ".claude/hooks/progress-tracker.py"
      - "MCPServer/worker/src/index.ts"
    tags:
      - enhancement
      - ui
      - session-state
      - glanceable
    commit_template: "feat(ui): Display rich session state (activity, todos, time, tokens)"
  - id: "FE2b"
    title: "Add stop/play interrupt controls to watch"
    description: |
      GOAL: Replace "(ctrl+c to interrupt)" with actual watch controls.
      There's no keyboard on the watch - we need tap-based controls.

      UI DESIGN:
      ```
      ┌─────────────────────────────────────┐
      │ ● Launching parallel review agents  │
      │   1m 27s · ↓ 5.4k tokens            │
      │                                     │
      │   ┌─────────┐   ┌─────────┐         │
      │   │  ⏸ Stop │   │ ▶ Resume│         │
      │   └─────────┘   └─────────┘         │
      └─────────────────────────────────────┘
      ```

      CONTROLS:
      - ⏸ Stop/Pause: Send interrupt signal to Claude Code session
      - ▶ Resume/Play: Resume paused session (if supported)
      - Maybe single toggle button that switches state

      IMPLEMENTATION:
      1. Add interrupt endpoint to worker: POST /session-interrupt
         - Accepts: { pairingId, action: "stop" | "resume" }
         - Stores interrupt request in KV
         - Hook polls or receives via mechanism TBD

      2. Add hook to check for interrupt requests
         - Could poll /session-interrupt/:pairingId
         - Or use existing WebSocket connection
         - When interrupt received, exit with special code

      3. Watch UI:
         - Add InterruptControls view with stop/play buttons
         - Show only when session is active
         - Haptic feedback on tap
         - Visual state change (button highlights)

      CHALLENGES:
      - How does hook receive interrupt? Polling vs push
      - What happens on "resume"? May need Claude Code changes
      - Consider just "Stop" initially, no resume

      MVP: Just "Stop" button that kills the session gracefully.
    priority: medium
    parallel_group: 2
    completed: false
    depends_on:
      - "FE2a"
    verification: |
      grep -q "InterruptControls\|stopSession" ClaudeWatch/Views/MainView.swift
    acceptance_criteria:
      - "Stop button visible during active session"
      - "Tapping Stop sends interrupt to worker"
      - "Claude Code session receives interrupt signal"
      - "Haptic feedback on button tap"
      - "No 'ctrl+c' text shown on watch"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "MCPServer/worker/src/index.ts"
      - ".claude/hooks/progress-tracker.py"
    tags:
      - enhancement
      - ui
      - controls
      - interrupt
    commit_template: "feat(ui): Add stop/play interrupt controls"
  # ═══════════════════════════════════════════════════════════════════════════
  # KNOWN ISSUES - TO FIX
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "BUG1"
    title: "Mode toggle (Normal/Auto-Approve/Plan) not working on watch"
    description: |
      ISSUE: The NORMAL | AUTO-APPROVE | PLAN mode toggle does not work
      on the Apple Watch (tested in simulator).

      FIXED (2026-01-19):
      The mode toggle UI was working, but AUTO-APPROVE mode wasn't actually
      auto-approving incoming actions. Fixed by adding auto-approve checks in:

      1. fetchPendingRequests() - cloud polling
         - Now auto-approves all actions when in autoAccept mode
      2. addPendingActionFromNotification() - push notifications
         - Now auto-approves instead of queueing when in autoAccept mode
      3. handleActionRequested() - WebSocket mode
         - Now auto-approves instead of queueing when in autoAccept mode

      MODE TOGGLE: Works correctly (cycles Normal → Auto → Plan → Normal)
      PERSISTENCE: Works via @AppStorage("permissionMode")
      AUTO-APPROVE: Now actually auto-approves incoming actions
    priority: high
    parallel_group: 1
    completed: true
    verification: |
      # Set mode to AUTO, send notification, verify auto-approved
      echo "Manual verification required"
    acceptance_criteria:
      - "Mode cycles correctly: Normal → Auto → Plan → Normal"
      - "Mode persists after app restart"
      - "Auto-Approve mode auto-approves pending actions"
    files:
      - "ClaudeWatch/Views/MainView.swift"
      - "ClaudeWatch/Services/WatchService.swift"
      - "ClaudeWatch/App/ClaudeWatchApp.swift"
    tags:
      - bug
      - ui
      - modes
    commit_template: "fix(modes): Mode toggle working on watch"
  - id: "BUG2"
    title: "All Claude sessions interact with watch - should only be cc-watch session"
    description: |
      CRITICAL ISSUE: Currently ANY Claude Code session with a pairing ID
      sends progress/approval requests to the watch. This causes:
      - Multiple sessions fighting for watch attention
      - Confusion about which session a notification belongs to
      - Progress updates from unrelated sessions

      FIXED (2026-01-19):
      Implemented Option C (simple env var flag):
      - Hooks check for CLAUDE_WATCH_SESSION_ACTIVE=1 env var
      - If not set, hooks exit immediately (exit 0) - no watch interaction
      - cc-watch CLI needs to set this env var when starting a session

      HOOKS UPDATED:
      - watch-approval-cloud.py: Added session check at top of main()
      - progress-tracker.py: Added session check at top of main()

      TO USE:
      - cc-watch needs to: export CLAUDE_WATCH_SESSION_ACTIVE=1
      - Or manually: CLAUDE_WATCH_SESSION_ACTIVE=1 claude
      - Without the env var, hooks are completely silent
    priority: critical
    parallel_group: 1
    completed: true
    verification: |
      # Without env var - exits immediately
      echo '{"tool_name": "Bash"}' | python3 .claude/hooks/watch-approval-cloud.py && echo "PASS"
    acceptance_criteria:
      - "Only cc-watch session sends to watch"
      - "Other sessions work normally"
      - "Clear indication of which session is active"
    files:
      - ".claude/hooks/watch-approval-cloud.py"
      - ".claude/hooks/progress-tracker.py"
    tags:
      - bug
      - critical
      - session-isolation
    commit_template: "fix(hooks): Only cc-watch session interacts with watch"
  - id: "BUG3"
    title: "Notification barrage - hard to track multiple notifications"
    description: |
      ISSUE: When multiple tool calls happen rapidly, the watch receives
      a barrage of notifications that's hard to keep track of.

      FIXED (2026-01-19):
      Implemented two-part solution:

      1. HOOK-SIDE DEBOUNCING (watch-approval-cloud.py):
         - Added 3-second debounce window
         - Only first notification in window is sent
         - Subsequent requests still created on server (for polling)
         - Tracks last notification time in /tmp/claude-watch-last-notification

      2. BADGE COUNT IN NOTIFICATIONS:
         - Hook: Shows "Claude: N actions pending" when multiple pending
         - Worker: Includes badge count in APNs payload
         - Notification body shows "Latest: <action>" for context

      HOW IT WORKS:
      - First action: Full notification with details
      - Actions within 3s: Debounced (request created, no notification)
      - Watch picks up pending actions via polling
      - Badge shows total pending count

      CONFIGURATION:
      - NOTIFICATION_DEBOUNCE_SECONDS = 3 in hook
      - Can be adjusted as needed
    priority: medium
    parallel_group: 2
    completed: true
    verification: |
      # Rapid tool calls should only trigger one notification per 3s window
      echo "Manual testing with rapid tool calls"
    acceptance_criteria:
      - "Notifications don't overwhelm the user"
      - "Easy to see total pending count"
      - "Can still approve individual actions"
    files:
      - ".claude/hooks/watch-approval-cloud.py"
      - "MCPServer/worker/src/index.js"
    tags:
      - enhancement
      - ux
      - notifications
    commit_template: "fix(notifications): Reduce notification barrage"
  # ═══════════════════════════════════════════════════════════════════════════
  # BLOCKED/DEFERRED TASKS
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "SP1"
    title: "Add clipboard paste button for pairing"
    description: |
      BLOCKED: UIPasteboard is NOT available on watchOS.

      Requires WatchConnectivity + iPhone companion app.
      Deferred until after physical device flow works.
    priority: low
    parallel_group: 99
    completed: true # Marked complete to skip
    blocked: true
    blocked_reason: "UIPasteboard not available on watchOS. Requires iPhone companion app."
    verification: |
      exit 0  # Skip
    acceptance_criteria:
      - "DEFERRED - requires iPhone companion app"
    files: []
    tags:
      - pairing
      - blocked
      - deferred
    commit_template: "feat(pairing): Add clipboard paste (deferred)"
  - id: "DBG-CLOUD"
    title: "Cloud server connectivity issues detected"
    description: |
      AUTO-DETECTED BUG from Watch Debug Monitor
      Detected at: 2026-01-19 13:15:42

      The watch debug monitor detected 3 cloud connectivity failures in the last 5 minutes.

Symptoms:
- Cloud server returning non-200 status
- Requests timing out
- Hook failing to create approval requests

Possible causes:
- Cloudflare Worker down
- Network issues
- Rate limiting

To investigate:
```bash
curl -v https://claude-watch.fotescodev.workers.dev/health
```

      Debug logs: .claude/logs/watch-debug/
    priority: high
    parallel_group: 1
    completed: false
    verification: |
      echo "Verify bug is fixed"
    acceptance_criteria:
      - "Issue no longer occurs"
      - "Debug monitor shows healthy status"
    files: []
    tags:
      - bug
      - auto-detected
      - cloud
      - connectivity
    commit_template: "fix(watch): Cloud server connectivity issues detected"
  - id: "DBG-TIMEOUT"
    title: "Multiple request timeouts detected"
    description: |
      AUTO-DETECTED BUG from Watch Debug Monitor
      Detected at: 2026-01-19 13:30:50

      The watch debug monitor detected 2 request timeouts in the last 10 minutes.

Symptoms:
- Approval requests not being responded to
- Claude Code hanging waiting for approval
- Watch may not be receiving notifications

Possible causes:
- Watch app not running
- Watch not receiving push notifications
- Network issues on watch
- Watch has stale pairing ID

To investigate:
1. Check watch app is running
2. Verify pairing IDs match
3. Send test notification:
   ```bash
   .claude/hooks/watch-debug-monitor.sh --test
   ```

      Debug logs: .claude/logs/watch-debug/
    priority: high
    parallel_group: 1
    completed: false
    verification: |
      echo "Verify bug is fixed"
    acceptance_criteria:
      - "Issue no longer occurs"
      - "Debug monitor shows healthy status"
    files: []
    tags:
      - bug
      - auto-detected
      - timeout
      - notifications
    commit_template: "fix(watch): Multiple request timeouts detected"
  # ═══════════════════════════════════════════════════════════════════════════
  # COMPETITIVE PARITY: Learnings from Happy Coder
  # Source: .claude/analysis/happy-vs-claude-watch-comparison.md
  # Reference repos: happy-cli-reference/, happy-server-reference/
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "COMP1"
    title: "Add SessionStart hook for reliable session tracking"
    description: |
      COMPETITIVE INSIGHT: Happy uses SessionStart hook to reliably track
      session IDs across resume, continue, fork, and compact operations.
      Claude Watch currently uses PreToolUse (fires per-tool) and misses
      session ID changes.

      WHAT HAPPY DOES:
      - SessionStart hook fires once per session start/resume/fork
      - Captures session ID immediately
      - Tracks across --continue, --resume flags
      - Handles /compact session forks
      - Handles double-escape forks

      IMPLEMENTATION:
      1. Create .claude/hooks/session-start.py
         - Parse CLAUDE_SESSION_ID from environment or stdin
         - Store in ~/.claude-watch-session
         - POST to /session-start endpoint on worker

      2. Register hook in .claude/settings.json:
         ```json
         "SessionStart": [{
           "hooks": [{
             "type": "command",
             "command": "python3 .claude/hooks/session-start.py"
           }]
         }]
         ```

      3. Add /session-start endpoint to worker:
         - Store session ID with pairing ID
         - Enable session history features

      4. Update watch UI to show session ID (optional)

      REFERENCE FILES:
      - happy-cli-reference/src/claude/session.ts (Session class)
      - happy-cli-reference/src/claude/utils/generateHookSettings.ts

      VALUE:
      - Enables "resume session" feature
      - Enables session message history
      - More reliable session tracking
    priority: medium
    parallel_group: 1
    completed: false
    verification: |
      [ -f .claude/hooks/session-start.py ] && \
      grep -q "SessionStart" .claude/settings.json
    acceptance_criteria:
      - "SessionStart hook fires on session start"
      - "Session ID tracked across resume/fork"
      - "Worker stores session metadata"
      - "Watch can display session info"
    files:
      - ".claude/hooks/session-start.py"
      - ".claude/settings.json"
      - "MCPServer/worker/src/index.ts"
    tags:
      - competitive-parity
      - happy-learning
      - session-tracking
    commit_template: "feat(hooks): Add SessionStart hook for session tracking"
  - id: "COMP2"
    title: "Add thinking state indicator to watch UI"
    description: |
      COMPETITIVE INSIGHT: Happy shows "Claude is thinking..." by intercepting
      fetch() calls. Claude Watch has no thinking indicator - user doesn't
      know if Claude is processing or idle.

      WHAT HAPPY DOES:
      - Wraps global.fetch() in launcher script
      - Emits fetch-start/fetch-end events via fd3 pipe
      - Mobile app shows pulsing "thinking" indicator
      - Real-time feedback during API calls

      IMPLEMENTATION OPTIONS:

      Option A: PostToolUse timing (simpler)
      - Track time between PostToolUse events
      - If >3 seconds since last tool, assume "thinking"
      - Less accurate but no Claude Code changes needed

      Option B: API proxy (Happy's approach)
      - Requires wrapping Claude's node process
      - More complex setup
      - Most accurate

      Option C: cc-watch CLI enhancement
      - cc-watch wraps claude and intercepts output
      - Detects "Thinking..." in terminal output
      - Forwards to worker

      RECOMMENDED: Start with Option A (timing heuristic)

      WATCH UI CHANGES:
      1. Add ThinkingState to WatchService:
         ```swift
         @Published var isThinking: Bool = false
         ```

      2. Update MainView to show pulsing indicator:
         ```swift
         if service.isThinking {
           PulsingDot()
           Text("Claude is thinking...")
         }
         ```

      3. Set isThinking = true when no activity for 3+ seconds
         during active session

      REFERENCE FILES:
      - happy-cli-reference/scripts/claude_local_launcher.cjs (fetch interception)
      - happy-reference/sources/components/tools/ThinkingIndicator.tsx
    priority: low
    parallel_group: 2
    completed: false
    depends_on:
      - "COMP1"
    verification: |
      grep -q "isThinking\|ThinkingState" ClaudeWatch/Services/WatchService.swift
    acceptance_criteria:
      - "Watch shows 'thinking' indicator"
      - "Indicator appears during API calls"
      - "Indicator clears when tool executes"
      - "Pulsing animation for visual feedback"
    files:
      - "ClaudeWatch/Services/WatchService.swift"
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - competitive-parity
      - happy-learning
      - ux
    commit_template: "feat(ui): Add thinking state indicator"
  - id: "COMP3"
    title: "Implement E2E encryption (zero-knowledge server)"
    description: |
      COMPETITIVE INSIGHT: Happy uses TweetNaCl for end-to-end encryption.
      Their server CANNOT read user code or session data. Claude Watch
      currently uses HTTPS only - server sees all request data in plaintext.

      WHAT HAPPY DOES:
      - Client generates keypair from QR code secret
      - Per-session encryption keys derived
      - All messages encrypted before transmission
      - Server stores only encrypted blobs
      - Decryption happens on device only

      WHY IT MATTERS:
      - Enterprise customers require E2E for code security
      - Zero-knowledge = can't be compelled to reveal data
      - Audit-friendly security model
      - Competitive differentiator

      IMPLEMENTATION PHASES:

      Phase 1: Add encryption to CLI (cc-watch)
      - Add tweetnacl-js dependency
      - Generate keypair during pairing
      - Store private key locally
      - Send public key to server

      Phase 2: Add encryption to worker
      - Store only encrypted request payloads
      - Forward encrypted blobs to watch
      - Never decrypt on server

      Phase 3: Add decryption to watch
      - Add TweetNaCl-swift or CryptoKit equivalent
      - Decrypt requests on device
      - Encrypt responses before sending

      REFERENCE FILES:
      - happy-server-reference/sources/modules/encrypt.ts
      - happy-reference/sources/sync/encryption/encryption.ts
      - happy-cli-reference/src/utils/hmac_sha512.ts

      COMPLEXITY: High - touches all components
      TIMELINE: Multi-phase implementation
    priority: medium
    parallel_group: 3
    completed: false
    verification: |
      grep -q "NaCl\|encrypt\|decrypt" MCPServer/worker/src/index.ts
    acceptance_criteria:
      - "Requests encrypted client-side"
      - "Server stores only ciphertext"
      - "Watch decrypts locally"
      - "No plaintext in server logs/storage"
    files:
      - "MCPServer/worker/src/index.ts"
      - "ClaudeWatch/Services/EncryptionService.swift"
    tags:
      - competitive-parity
      - happy-learning
      - security
      - encryption
      - multi-phase
    commit_template: "feat(security): Add E2E encryption (phase N)"
  - id: "COMP4"
    title: "Add activity batching (2-second flush)"
    description: |
      COMPETITIVE INSIGHT: Happy batches high-frequency updates and flushes
      every 2 seconds. This prevents state thrashing and reduces network
      traffic. Claude Watch updates on every event.

      WHAT HAPPY DOES:
      ```typescript
      private activityAccumulator: ActivityUpdateAccumulator;

      handleEphemeralUpdate(update) {
          this.activityAccumulator.add(update);
          // Flushed every 2 seconds
      }

      private flushActivityUpdates(updates) {
          storage.getState().applyActivityUpdates(updates);
      }
      ```

      BENEFITS:
      - Reduced network calls
      - Smoother UI updates
      - Lower battery drain
      - Better performance on watch

      IMPLEMENTATION:

      1. Add ActivityBatcher to WatchService:
         ```swift
         class ActivityBatcher {
           private var pendingUpdates: [ProgressUpdate] = []
           private var flushTimer: Timer?

           func add(_ update: ProgressUpdate) {
             pendingUpdates.append(update)
             scheduleFlush()
           }

           private func scheduleFlush() {
             flushTimer?.invalidate()
             flushTimer = Timer.scheduledTimer(withTimeInterval: 2.0, repeats: false) {
               self.flush()
             }
           }

           private func flush() {
             let updates = pendingUpdates
             pendingUpdates = []
             // Apply all updates at once
             applyUpdates(updates)
           }
         }
         ```

      2. Route progress updates through batcher
      3. Only update UI once per 2-second window

      REFERENCE FILES:
      - happy-reference/sources/sync/sync.ts (ActivityUpdateAccumulator)

      COMPLEXITY: Low-medium
    priority: low
    parallel_group: 2
    completed: false
    verification: |
      grep -q "ActivityBatcher\|flushInterval" ClaudeWatch/Services/WatchService.swift
    acceptance_criteria:
      - "Updates batched over 2-second window"
      - "UI updates smoothly (no flickering)"
      - "Reduced network calls"
      - "Battery usage improved"
    files:
      - "ClaudeWatch/Services/WatchService.swift"
    tags:
      - competitive-parity
      - happy-learning
      - performance
    commit_template: "perf(service): Add activity batching for smoother updates"
  # ═══════════════════════════════════════════════════════════════════════════
  # E2E TESTING BUGS - 2026-01-24
  # Discovered during comprehensive cloud + simulator testing session
  # ═══════════════════════════════════════════════════════════════════════════
  - id: "E2E-P0-1"
    title: "Fix PostToolUse hooks not firing during Claude Code sessions"
    description: |
      CRITICAL BUG: PostToolUse hooks are registered in settings.json but
      not being invoked by Claude Code at runtime.

      SYMPTOMS:
      - Hook debug log (~/.claude-watch-hook-debug.log) never created
      - progress-tracker.py never executes during tool use
      - Watch shows "idle" even during active coding sessions
      - Manual curl to /session-progress works, but automatic sync doesn't

      ROOT CAUSE INVESTIGATION NEEDED:
      1. Check if Claude Code restart is required after settings.json changes
      2. Verify hook matcher pattern is correct: "Read|Write|Edit|Grep|Glob|Bash|TodoWrite|TaskCreate|TaskUpdate|TaskList"
      3. Test hook execution with debug logging:
         ```python
         # Add to top of progress-tracker.py
         with open("/tmp/hook-fired.log", "a") as f:
             f.write(f"{datetime.now()}: Hook fired\n")
         ```
      4. Check Claude Code version compatibility with PostToolUse hooks

      VERIFICATION:
      ```bash
      # During active session, this file should exist and update
      cat /tmp/hook-fired.log
      ```

      WORKAROUND (current):
      Manual sync via curl to /session-progress endpoint.

      PRIORITY: P0 - This blocks all automatic watch sync features
    priority: critical
    parallel_group: 1
    completed: false
    verification: |
      [ -f /tmp/hook-fired.log ] && [ $(wc -l < /tmp/hook-fired.log) -gt 0 ]
    acceptance_criteria:
      - "Hook debug log created during Claude Code session"
      - "progress-tracker.py executes on each tool use"
      - "Watch receives automatic progress updates"
      - "No manual curl required for sync"
    files:
      - ".claude/settings.json"
      - ".claude/hooks/progress-tracker.py"
    tags:
      - bug
      - critical
      - e2e-testing
      - hooks
    commit_template: "fix(hooks): PostToolUse hooks now fire correctly"
  - id: "E2E-P0-2"
    title: "Fix watch showing 'Idle' status during active sessions"
    description: |
      BUG: Watch displays "Session idle for X minutes" while actively
      working with Claude Code.

      SYMPTOMS:
      - StatusHeader shows "Session Idle" with timer
      - Even during rapid tool use (Read, Edit, Grep)
      - "6 minutes idle" displayed during active conversation
      - Caused by E2E-P0-1 (hooks not firing)

      ROOT CAUSE:
      - progressStaleThreshold = 300 seconds (5 minutes)
      - No progress updates received (hooks not firing)
      - Watch assumes idle when no recent /session-progress data

      FIX (after E2E-P0-1 resolved):
      1. Ensure heartbeat sent on every tool use
      2. Add fallback polling from watch to /session-progress/:pairingId
      3. Consider shorter staleness threshold for "thinking" state

      DATA FLOW:
      ```
      Tool use → Hook → /session-progress → APNs → Watch
                                ↓
                        KV: progress:${pairingId}
      ```

      FALLBACK POLLING (if hooks unreliable):
      Add timer in WatchService to poll /session-progress every 30s
      when session is active.
    priority: critical
    parallel_group: 1
    completed: false
    depends_on:
      - "E2E-P0-1"
    verification: |
      # During active Claude session, watch should not show "idle"
      echo "Manual verification - watch shows Working state"
    acceptance_criteria:
      - "Watch shows 'Working' during active tool use"
      - "Progress updates arrive within 5 seconds of tool use"
      - "No false 'idle' states during active sessions"
    files:
      - "ClaudeWatch/Services/WatchService.swift"
      - "ClaudeWatch/Views/MainView.swift"
      - ".claude/hooks/progress-tracker.py"
    tags:
      - bug
      - critical
      - e2e-testing
      - status
    commit_template: "fix(status): Show Working state during active sessions"
  - id: "E2E-P0-3"
    title: "Fix task list not syncing to watch automatically"
    description: |
      BUG: Watch task list shows stale data or "Test task" placeholder
      instead of real task list from Claude Code.

      SYMPTOMS:
      - TaskCreate in terminal doesn't appear on watch
      - TaskUpdate status changes not reflected
      - Watch may show old/test data from previous sessions
      - Manual curl sync works, automatic sync doesn't

      ROOT CAUSE: E2E-P0-1 (hooks not firing)

      IMPLEMENTATION (in progress-tracker.py):
      ```python
      def handle_task_tools(tool_name, tool_input):
          if tool_name == "TaskCreate":
              task = extract_task(tool_input)
              tasks = load_task_state()
              tasks.append(task)
              save_task_state(tasks)
              send_to_cloud(tasks)
          elif tool_name == "TaskUpdate":
              task_id = tool_input.get("taskId")
              updates = extract_updates(tool_input)
              tasks = update_task_in_state(task_id, updates)
              send_to_cloud(tasks)
      ```

      LOCAL STATE FILE: ~/.claude-watch-tasks.json
      - Persists tasks between hook invocations
      - Synced to cloud on each update

      CLOUD PAYLOAD:
      ```json
      {
        "pairingId": "...",
        "tasks": [
          {"id": "1", "subject": "Task 1", "status": "completed"},
          {"id": "2", "subject": "Task 2", "status": "in_progress"}
        ]
      }
      ```
    priority: critical
    parallel_group: 1
    completed: false
    depends_on:
      - "E2E-P0-1"
    verification: |
      # Create task in Claude, verify watch shows it
      echo "Manual verification - create TaskCreate, check watch"
    acceptance_criteria:
      - "TaskCreate appears on watch within 5 seconds"
      - "TaskUpdate status changes reflected on watch"
      - "Task list persists in ~/.claude-watch-tasks.json"
      - "Watch shows expandable task list during Working state"
    files:
      - ".claude/hooks/progress-tracker.py"
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - bug
      - critical
      - e2e-testing
      - tasks
    commit_template: "fix(tasks): Auto-sync task list to watch"
  - id: "E2E-P1-1"
    title: "Fix History not recording context warnings"
    description: |
      BUG: Context warnings (e.g., "Context at 80%") don't appear in
      the History view's activity log.

      SYMPTOMS:
      - Context warning notification received
      - Warning not added to ActivityStore
      - History shows other events but not context warnings

      INVESTIGATION:
      1. Check if /context endpoint exists on cloud worker (returns 404)
      2. Verify ActivityStore.recordContextWarning() is called
      3. Check notification handler in ClaudeWatchApp for "context" type

      IMPLEMENTATION:
      1. Add /context endpoint to Cloudflare worker:
         ```typescript
         router.post('/context', async (request, env) => {
           const { pairingId, percentage, message } = await request.json();
           // Send APNs notification with type: "context"
         });
         ```

      2. Handle "context" notification type in ClaudeWatchApp:
         ```swift
         case "context":
           let percentage = userInfo["percentage"] as? Int ?? 0
           ActivityStore.shared.recordContextWarning(percentage: percentage)
         ```

      3. Add hook to detect context warnings:
         - Could use SubagentStop hook
         - Or add to progress-tracker.py with context detection

      REFERENCE:
      - ClaudeWatch/Services/ActivityStore.swift:132-140 (recordContextWarning)
      - ClaudeWatch/Views/HistoryView.swift
    priority: high
    parallel_group: 2
    completed: false
    verification: |
      grep -q "context" claude-watch-cloud/src/index.ts
    acceptance_criteria:
      - "/context endpoint exists on cloud worker"
      - "Context warnings appear in History view"
      - "ActivityStore.recordContextWarning called correctly"
      - "Events persist across app restarts"
    files:
      - "claude-watch-cloud/src/index.ts"
      - "ClaudeWatch/App/ClaudeWatchApp.swift"
      - ".claude/hooks/progress-tracker.py"
    tags:
      - bug
      - high
      - e2e-testing
      - history
    commit_template: "fix(history): Record context warnings in activity log"
  - id: "E2E-P1-2"
    title: "Add missing /question endpoint to cloud worker"
    description: |
      BUG: Question flow returns 404 - endpoint missing from cloud worker.

      SYMPTOMS:
      - POST /question returns 404
      - Questions never reach the watch
      - AskUserQuestion tool can't route to watch

      IMPLEMENTATION:
      Add question flow endpoints to cloud worker:

      ```typescript
      // Create question request
      router.post('/question', async (request, env) => {
        const { pairingId, questionId, question, options } = await request.json();

        // Store in KV
        await env.WATCH_KV.put(`question:${pairingId}:${questionId}`, JSON.stringify({
          question, options, timestamp: Date.now(), status: 'pending'
        }));

        // Queue for watch
        const queue = JSON.parse(await env.WATCH_KV.get(`question-queue:${pairingId}`) || '[]');
        queue.push(questionId);
        await env.WATCH_KV.put(`question-queue:${pairingId}`, JSON.stringify(queue));

        // Send APNs notification
        await sendPush(pairingId, {
          type: 'question',
          questionId,
          question,
          optionCount: options.length
        });

        return new Response(JSON.stringify({ success: true, questionId }));
      });

      // Watch responds to question
      router.post('/question/:questionId', async (request, env) => {
        const { answer } = await request.json();
        // Store answer, remove from queue
      });

      // Hook polls for answer
      router.get('/question/:pairingId/:questionId', async (request, env) => {
        const data = await env.WATCH_KV.get(`question:${pairingId}:${questionId}`);
        return new Response(data);
      });
      ```

      WATCH UI:
      - Already has QuestionResponseView.swift
      - Needs to handle "question" notification type

      HOOK:
      - question-handler.py exists in PreToolUse
      - Needs to call /question endpoint and poll for answer
    priority: high
    parallel_group: 2
    completed: false
    verification: |
      curl -s https://claude-watch.fotescodev.workers.dev/question -X POST -d '{}' | grep -v 404
    acceptance_criteria:
      - "POST /question endpoint returns 200"
      - "Questions stored in KV with pending status"
      - "APNs notification sent to watch"
      - "Watch can respond to questions"
      - "Hook receives answer via polling"
    files:
      - "claude-watch-cloud/src/index.ts"
      - ".claude/hooks/question-handler.py"
      - "ClaudeWatch/App/ClaudeWatchApp.swift"
    tags:
      - bug
      - high
      - e2e-testing
      - questions
    commit_template: "feat(cloud): Add /question endpoint for watch questions"
  - id: "E2E-P1-3"
    title: "Fix silent push not updating foreground UI"
    description: |
      BUG: Silent push notifications (content-available: 1) don't
      trigger UI updates when app is in foreground.

      SYMPTOMS:
      - Progress updates sent as silent push
      - Watch doesn't update until user interacts
      - Works when using alert-style notifications

      ROOT CAUSE:
      - Silent push requires didReceiveRemoteNotification delegate
      - NOT handled by willPresent (for alert-style only)
      - See: docs/solutions/integration-issues/watchos-silent-push-ui-update.md

      FIX OPTIONS:

      Option A: Use alert-style for all notifications
      ```json
      {
        "aps": {
          "alert": {"title": "Progress", "body": "Working on task"},
          "sound": "default"
        },
        "type": "progress",
        "data": {...}
      }
      ```
      Downside: Noisy for user

      Option B: Implement didReceiveRemoteNotification
      ```swift
      func application(_ application: WKApplication,
                       didReceiveRemoteNotification userInfo: [AnyHashable: Any],
                       fetchCompletionHandler: @escaping (WKBackgroundFetchResult) -> Void) {
        // Handle silent push
        processProgressUpdate(userInfo)
        fetchCompletionHandler(.newData)
      }
      ```

      Option C: Hybrid approach
      - Use silent push for progress updates (background refresh)
      - Use alert for action requests (needs user attention)
      - Add polling as fallback

      RECOMMENDED: Option C (hybrid)

      REFERENCE:
      - docs/solutions/integration-issues/watchos-silent-push-ui-update.md
    priority: high
    parallel_group: 2
    completed: false
    verification: |
      grep -q "didReceiveRemoteNotification" ClaudeWatch/App/ClaudeWatchApp.swift
    acceptance_criteria:
      - "Silent push updates UI in foreground"
      - "Progress updates don't require user interaction"
      - "Action requests still use alert-style"
      - "Background refresh works correctly"
    files:
      - "ClaudeWatch/App/ClaudeWatchApp.swift"
      - "claude-watch-cloud/src/index.ts"
    tags:
      - bug
      - high
      - e2e-testing
      - notifications
    commit_template: "fix(notifications): Handle silent push in foreground"
  - id: "E2E-P2-1"
    title: "Re-enable Bash approval hook for watch mode"
    description: |
      BUG: Bash PreToolUse hook is disabled in settings.json, marked
      with "_DISABLED_FOR_TESTING_" prefix.

      CURRENT STATE (line 109):
      ```json
      "matcher": "_DISABLED_FOR_TESTING_Bash|Write|Edit|MultiEdit|..."
      ```

      SHOULD BE:
      ```json
      "matcher": "Bash|Write|Edit|MultiEdit|..."
      ```

      REASON FOR DISABLE:
      - Was disabled during local development
      - Prevents interruption of development workflow
      - Should be re-enabled when using watch approval mode

      FIX:
      1. Edit .claude/settings.json
      2. Remove "_DISABLED_FOR_TESTING_" prefix from Bash
      3. Restart Claude Code session

      ALTERNATIVE:
      Create toggle script that enables/disables Bash hook:
      ```bash
      # .claude/hooks/toggle-bash-approval.sh
      if grep -q "_DISABLED_FOR_TESTING_Bash" .claude/settings.json; then
        sed -i '' 's/_DISABLED_FOR_TESTING_Bash/Bash/' .claude/settings.json
        echo "Bash approval enabled"
      else
        sed -i '' 's/"Bash|/"_DISABLED_FOR_TESTING_Bash|/' .claude/settings.json
        echo "Bash approval disabled"
      fi
      ```

      NOTE: Only relevant when CLAUDE_WATCH_SESSION_ACTIVE=1 is set
      (session isolation already implemented in hooks)
    priority: medium
    parallel_group: 3
    completed: false
    verification: |
      grep -q '"Bash|Write|Edit' .claude/settings.json
    acceptance_criteria:
      - "Bash commands require watch approval"
      - "Only when CLAUDE_WATCH_SESSION_ACTIVE=1"
      - "Toggle script available for enable/disable"
    files:
      - ".claude/settings.json"
    tags:
      - bug
      - medium
      - e2e-testing
      - configuration
    commit_template: "fix(hooks): Re-enable Bash approval for watch mode"
  - id: "E2E-P2-2"
    title: "Tune progress staleness threshold for better UX"
    description: |
      ISSUE: Progress staleness threshold was 60 seconds (too aggressive),
      extended to 300 seconds (may be too long).

      CURRENT BEHAVIOR:
      - After 300 seconds with no progress update, watch shows "Idle"
      - During long-running operations (builds, tests), watch may timeout
      - User sees misleading "idle" status

      OPTIMAL UX:
      - Show "Working" during any active Claude session
      - Show "Thinking..." when Claude is processing (no tool use)
      - Show "Idle" only when truly no session active

      IMPLEMENTATION:
      1. Reduce staleness to 120 seconds for "Working" → "Thinking" transition
      2. Add separate "Thinking" state when no recent tool use but session active
      3. Only show "Idle" when session explicitly ended or very stale (10+ min)

      STATE MACHINE:
      ```
      Working (tool use within 30s)
          ↓ no tool for 30s
      Thinking (session active, no recent tools)
          ↓ no update for 120s
      Idle (stale or no session)
      ```

      CODE CHANGE:
      ```swift
      private let workingThreshold: TimeInterval = 30
      private let thinkingThreshold: TimeInterval = 120
      private let idleThreshold: TimeInterval = 600

      var sessionDisplayState: SessionDisplayState {
          guard let lastUpdate = lastProgressUpdate else { return .idle }
          let elapsed = Date().timeIntervalSince(lastUpdate)

          if elapsed < workingThreshold { return .working }
          if elapsed < thinkingThreshold { return .thinking }
          if elapsed < idleThreshold { return .thinking } // Still show thinking
          return .idle
      }
      ```
    priority: medium
    parallel_group: 3
    completed: false
    verification: |
      grep -q "thinkingThreshold\|workingThreshold" ClaudeWatch/Services/WatchService.swift
    acceptance_criteria:
      - "Watch shows 'Thinking' during LLM processing"
      - "Watch shows 'Working' during tool execution"
      - "Watch shows 'Idle' only when truly idle"
      - "Smooth transitions between states"
    files:
      - "ClaudeWatch/Services/WatchService.swift"
      - "ClaudeWatch/Views/MainView.swift"
    tags:
      - enhancement
      - medium
      - e2e-testing
      - ux
    commit_template: "feat(status): Add Thinking state for better session awareness"
  - id: "E2E-P2-3"
    title: "History shows inflated task count (99 tasks)"
    description: |
      ISSUE: History view showed "99 tasks and 0 approvals" - confusing.

      ROOT CAUSE:
      - ActivityStore.currentSessionStats counts ALL .taskCompleted events
      - This includes events from entire day, not current task list
      - Preview/test data may have inflated the count

      FIX OPTIONS:

      Option A: Only count current session events
      ```swift
      var currentSessionStats: (tasks: Int, approvals: Int)? {
          guard let sessionId = currentSessionId else { return nil }
          let sessionEvents = events.filter { $0.sessionId == sessionId }
          // Count from current session only
      }
      ```

      Option B: Clear on session start
      ```swift
      func recordSessionStarted() {
          // Clear old events for clean session
          pruneEventsOlderThan(hours: 1)
          // Start new session
      }
      ```

      Option C: Show task list count, not event count
      ```swift
      // Show actual task list size, not completed event count
      Text("\(taskList.count) tasks")
      ```

      RECOMMENDED: Option A (scope to current session)

      UI COPY CHANGE:
      - "99 tasks" → "3 tasks in list" (actual count)
      - Or: "5 tasks completed" (clear it's historical)
    priority: medium
    parallel_group: 3
    completed: false
    verification: |
      grep -q "currentSessionStats" ClaudeWatch/Services/ActivityStore.swift
    acceptance_criteria:
      - "Task count reflects current session only"
      - "No inflated counts from old events"
      - "UI copy is clear about what's being counted"
    files:
      - "ClaudeWatch/Services/ActivityStore.swift"
      - "ClaudeWatch/Views/HistoryView.swift"
    tags:
      - bug
      - medium
      - e2e-testing
      - history
    commit_template: "fix(history): Scope task count to current session"
