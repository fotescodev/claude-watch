# CarPlay Claude - Ralph Task Definitions
# This file contains Ralph-formatted tasks for the CarPlay Claude MVP.
# These tasks are NOT yet integrated into the main tasks.yaml.
#
# To integrate when ready:
#   1. Append contents to .claude/ralph/tasks.yaml
#   2. Ensure parallel_group numbers don't conflict
#   3. Run: ./ralph.sh --parallel-group 20
#
# Spec: plans/CARPLAY_MVP_SPEC.md

version: "1.0"
project: "ClaudeMobile"
platform: "iOS + CarPlay"
min_deployment: "17.0"
swift_version: "5.9"
settings:
  require_build_pass: true
  require_accessibility: true
  require_hig_compliance: true

tasks:
  # ═══════════════════════════════════════════════════════════════════════════
  # PHASE 8: CARPLAY CLAUDE - iOS Companion App & CarPlay Integration
  # From: plans/CARPLAY_MVP_SPEC.md
  # Parallel Groups 20-23
  #
  # VISION: "Start Claude Code in terminal, scan QR, control from Watch/Car/Phone"
  # KEY FEATURES:
  # - Steering wheel buttons: ◀◀ reject, ▶▶ approve
  # - Voice interaction via Siri/call button
  # - Audio summaries of pending approvals
  # - Now Playing-style UI for quick glances
  # - Shared pairing with Watch via iOS companion app
  # ═══════════════════════════════════════════════════════════════════════════

  # --- Phase 8.1: iOS Companion App Foundation (parallel_group: 20) ---
  - id: "CP1"
    title: "Create iOS companion app project with App Groups"
    description: |
      Create the ClaudeMobile iOS app project that serves as the companion
      for both Apple Watch and CarPlay interfaces.

      Implementation:
      1. Create ClaudeMobile/ directory structure:
         - App/, Scenes/, Views/, Services/, Intents/, Resources/
      2. Create ClaudeMobile.xcodeproj with:
         - iOS deployment target: 17.0
         - App Group: group.com.claudewatch.shared
         - CarPlay entitlement: com.apple.developer.carplay-driving-task
      3. Create ClaudeMobileApp.swift @main entry point
      4. Create AppDelegate.swift for push notification handling
      5. Configure Info.plist with required keys:
         - NSCameraUsageDescription (QR scanning)
         - NSSiriUsageDescription (voice control)
         - UIBackgroundModes (audio, remote-notification, voip)
         - UIApplicationSceneManifest (CarPlay scene config)

      File structure:
      ```
      ClaudeMobile/
      ├── App/
      │   ├── ClaudeMobileApp.swift
      │   └── AppDelegate.swift
      ├── Scenes/
      │   ├── CarPlay/
      │   └── Phone/
      ├── Views/
      ├── Services/
      ├── Intents/
      └── Resources/
      ```
    priority: critical
    parallel_group: 20
    completed: false
    verification: |
      [ -d "ClaudeMobile" ] && \
      [ -f "ClaudeMobile/App/ClaudeMobileApp.swift" ] && \
      [ -f "ClaudeMobile/App/AppDelegate.swift" ] && exit 0 || exit 1
    acceptance_criteria:
      - "ClaudeMobile directory structure created"
      - "Xcode project with App Groups entitlement"
      - "CarPlay entitlement configured"
      - "Info.plist with all required keys"
      - "Basic app launches in simulator"
    files:
      - "ClaudeMobile/App/ClaudeMobileApp.swift"
      - "ClaudeMobile/App/AppDelegate.swift"
      - "ClaudeMobile/Info.plist"
      - "ClaudeMobile/ClaudeMobile.entitlements"
    tags:
      - carplay
      - ios
      - project-setup
      - foundation
    commit_template: "feat(carplay): Create iOS companion app project"

  - id: "CP2"
    title: "Implement QR scanner view for pairing"
    description: |
      Create QRScannerView using AVFoundation for camera-based QR code pairing.
      This enables faster pairing than manual code entry.

      Implementation:
      1. Create ClaudeMobile/Views/QRScannerView.swift
      2. Create QRScanner ObservableObject with:
         - AVCaptureSession management
         - AVCaptureMetadataOutput for QR detection
         - scannedCode published property
      3. Create CameraPreviewView UIViewRepresentable
      4. Implement QR code URL parsing:
         - Scheme: claude-watch://
         - Host: pair
         - Query: code=ABC-123&server=wss://...
      5. Add viewfinder overlay with scanning animation
      6. Add "Enter Code Manually" fallback button

      QR URL format:
      ```
      claude-watch://pair?code=ABC-123&server=wss://claude-watch.fotescodev.workers.dev
      ```

      Pattern for handling scan:
      ```swift
      private func handleScannedCode(_ code: String) {
          guard let url = URL(string: code),
                url.scheme == "claude-watch",
                url.host == "pair",
                let components = URLComponents(url: url, resolvingAgainstBaseURL: false),
                let pairingCode = components.queryItems?.first(where: { $0.name == "code" })?.value
          else { return }

          Task {
              try await SharedService.shared.completePairing(code: pairingCode)
          }
      }
      ```
    priority: critical
    parallel_group: 20
    completed: false
    verification: |
      [ -f "ClaudeMobile/Views/QRScannerView.swift" ] && \
      grep -q 'AVCaptureSession\|AVCaptureMetadataOutput' ClaudeMobile/Views/QRScannerView.swift && \
      grep -q 'claude-watch://pair' ClaudeMobile/Views/QRScannerView.swift && exit 0 || exit 1
    acceptance_criteria:
      - "QRScannerView with camera preview"
      - "QR code detection via AVCaptureMetadataOutput"
      - "URL parsing for claude-watch:// scheme"
      - "Viewfinder overlay with visual feedback"
      - "Manual entry fallback button"
    files:
      - "ClaudeMobile/Views/QRScannerView.swift"
    tags:
      - carplay
      - pairing
      - camera
      - qr-code
    commit_template: "feat(carplay): Implement QR scanner for pairing"

  - id: "CP3"
    title: "Create SharedService for App Group state sync"
    description: |
      Create SharedService that manages state shared between Watch, iPhone,
      and CarPlay via App Groups.

      Implementation:
      1. Create ClaudeMobile/Services/SharedService.swift
      2. Create Shared/Models/SharedModels.swift with:
         - SharedPairingState (pairingId, cloudServerURL, deviceToken, etc.)
         - PendingAction with RiskLevel enum
         - SessionState
         - ConnectionStatus
      3. SharedService singleton with:
         - UserDefaults(suiteName: "group.com.claudewatch.shared")
         - @Published state properties
         - completePairing(code:) async throws
         - respondToRequest(requestId:, approved:) async throws
         - Cloud polling for pending requests
      4. Port patterns from WatchService.swift:
         - Connection management
         - Message queue
         - Error handling

      Key patterns from WatchService to reuse:
      - ReconnectionConfig for exponential backoff
      - QueuedMessage for reliable delivery
      - Cloud polling with pollingInterval
    priority: critical
    parallel_group: 20
    completed: false
    depends_on:
      - "CP1"
    verification: |
      [ -f "ClaudeMobile/Services/SharedService.swift" ] && \
      grep -q 'group.com.claudewatch' ClaudeMobile/Services/SharedService.swift && \
      grep -q 'completePairing\|pairingId' ClaudeMobile/Services/SharedService.swift && exit 0 || exit 1
    acceptance_criteria:
      - "SharedService with App Group UserDefaults"
      - "SharedPairingState Codable struct"
      - "Cloud pairing API integration"
      - "State sync across Watch/Phone/CarPlay"
      - "Patterns ported from WatchService"
    files:
      - "ClaudeMobile/Services/SharedService.swift"
      - "Shared/Models/SharedModels.swift"
    tags:
      - carplay
      - state-management
      - app-groups
      - shared
    commit_template: "feat(carplay): Create SharedService for App Group sync"

  - id: "CP4"
    title: "Implement iOS companion app views (Home, Settings, Pairing)"
    description: |
      Create the main views for the iOS companion app.

      Implementation:
      1. Create ClaudeMobile/Views/HomeView.swift:
         - Connection status indicator
         - Current task display
         - Pending actions count
         - Quick actions (Approve All, Settings)
      2. Create ClaudeMobile/Views/PairingView.swift:
         - Code input TextField
         - QR scan button
         - Validation feedback
      3. Create ClaudeMobile/Views/SettingsView.swift:
         - Server URL configuration
         - Audio preferences
         - Unpair button
         - Watch/CarPlay status
      4. Create ClaudeMobile/Views/ApprovalListView.swift:
         - List of pending approvals
         - Swipe to approve/reject
         - Detail expansion

      Navigation structure:
      ```swift
      NavigationStack {
          HomeView()
              .sheet(isPresented: $showPairing) {
                  QRScannerView()
              }
              .sheet(isPresented: $showSettings) {
                  SettingsView()
              }
      }
      ```
    priority: high
    parallel_group: 20
    completed: false
    depends_on:
      - "CP3"
    verification: |
      [ -f "ClaudeMobile/Views/HomeView.swift" ] && \
      [ -f "ClaudeMobile/Views/SettingsView.swift" ] && \
      [ -f "ClaudeMobile/Views/ApprovalListView.swift" ] && exit 0 || exit 1
    acceptance_criteria:
      - "HomeView with status and quick actions"
      - "PairingView with code input and QR button"
      - "SettingsView with all configuration options"
      - "ApprovalListView with swipe actions"
      - "NavigationStack-based navigation"
    files:
      - "ClaudeMobile/Views/HomeView.swift"
      - "ClaudeMobile/Views/PairingView.swift"
      - "ClaudeMobile/Views/SettingsView.swift"
      - "ClaudeMobile/Views/ApprovalListView.swift"
    tags:
      - carplay
      - ios
      - swiftui
      - views
    commit_template: "feat(carplay): Implement iOS companion app views"

  - id: "CP5"
    title: "Add push notification handling for iOS app"
    description: |
      Implement push notification registration and handling for the iOS app.

      Implementation:
      1. Update AppDelegate.swift:
         - UNUserNotificationCenter delegate
         - registerForRemoteNotifications()
         - didRegisterForRemoteNotifications(withDeviceToken:)
      2. Create notification categories:
         - CLAUDE_ACTION with Approve/Reject/ApproveAll actions
      3. Handle notification responses:
         - APPROVE_ACTION
         - REJECT_ACTION
         - APPROVE_ALL_ACTION
      4. Store device token in SharedService for cloud pairing
      5. Handle foreground notification presentation

      Pattern (from watchOS AppDelegate):
      ```swift
      func userNotificationCenter(
          _ center: UNUserNotificationCenter,
          didReceive response: UNNotificationResponse,
          withCompletionHandler completionHandler: @escaping () -> Void
      ) {
          let requestId = response.notification.request.content.userInfo["requestId"] as? String
          switch response.actionIdentifier {
          case "APPROVE_ACTION":
              Task { try? await SharedService.shared.respondToRequest(requestId!, approved: true) }
          case "REJECT_ACTION":
              Task { try? await SharedService.shared.respondToRequest(requestId!, approved: false) }
          default: break
          }
          completionHandler()
      }
      ```
    priority: high
    parallel_group: 20
    completed: false
    depends_on:
      - "CP3"
    verification: |
      grep -q 'UNUserNotificationCenter\|registerForRemoteNotifications' ClaudeMobile/App/AppDelegate.swift && \
      grep -q 'CLAUDE_ACTION\|APPROVE_ACTION' ClaudeMobile/App/AppDelegate.swift && exit 0 || exit 1
    acceptance_criteria:
      - "Push notification registration"
      - "Notification categories with actions"
      - "Action handlers for approve/reject"
      - "Device token storage in SharedService"
      - "Foreground notification display"
    files:
      - "ClaudeMobile/App/AppDelegate.swift"
    tags:
      - carplay
      - notifications
      - apns
      - ios
    commit_template: "feat(carplay): Add push notification handling"

  # --- Phase 8.2: CarPlay Integration (parallel_group: 21) ---
  - id: "CP6"
    title: "Create CarPlay scene delegate"
    description: |
      Implement CarPlaySceneDelegate for CarPlay lifecycle management.

      Implementation:
      1. Create ClaudeMobile/Scenes/CarPlay/CarPlaySceneDelegate.swift
      2. Implement CPTemplateApplicationSceneDelegate:
         - templateApplicationScene(_:didConnect:)
         - templateApplicationScene(_:didDisconnect:)
      3. Store interfaceController reference
      4. Set up root template (CPTabBarTemplate or CPNowPlayingTemplate)
      5. Handle CarPlay connection/disconnection events
      6. Update SharedService.carPlayActive state

      CarPlay scene configuration (Info.plist):
      ```xml
      <key>CPTemplateApplicationSceneSessionRoleApplication</key>
      <array>
          <dict>
              <key>UISceneClassName</key>
              <string>CPTemplateApplicationScene</string>
              <key>UISceneDelegateClassName</key>
              <string>$(PRODUCT_MODULE_NAME).CarPlaySceneDelegate</string>
              <key>UISceneConfigurationName</key>
              <string>CarPlay</string>
          </dict>
      </array>
      ```
    priority: critical
    parallel_group: 21
    completed: false
    depends_on:
      - "CP1"
      - "CP3"
    verification: |
      [ -f "ClaudeMobile/Scenes/CarPlay/CarPlaySceneDelegate.swift" ] && \
      grep -q 'CPTemplateApplicationSceneDelegate\|didConnect.*interfaceController' ClaudeMobile/Scenes/CarPlay/CarPlaySceneDelegate.swift && exit 0 || exit 1
    acceptance_criteria:
      - "CarPlaySceneDelegate implements CPTemplateApplicationSceneDelegate"
      - "Handles didConnect/didDisconnect lifecycle"
      - "Sets up root template on connection"
      - "Updates SharedService.carPlayActive"
      - "Info.plist scene configuration correct"
    files:
      - "ClaudeMobile/Scenes/CarPlay/CarPlaySceneDelegate.swift"
      - "ClaudeMobile/Info.plist"
    tags:
      - carplay
      - scene-delegate
      - lifecycle
    commit_template: "feat(carplay): Create CarPlay scene delegate"

  - id: "CP7"
    title: "Implement CPNowPlayingTemplate for approval queue"
    description: |
      Create the primary CarPlay UI using CPNowPlayingTemplate to display
      pending approvals as "tracks" in a media player-like interface.

      Implementation:
      1. Create ClaudeMobile/Scenes/CarPlay/CarPlayService.swift
      2. Create NowPlayingInfo struct for display state
      3. Implement MPNowPlayingInfoCenter updates:
         - MPMediaItemPropertyTitle: Action title
         - MPMediaItemPropertyArtist: "Claude Code"
         - MPMediaItemPropertyAlbumTitle: Task name
         - MPNowPlayingInfoPropertyPlaybackQueueIndex: Current index
         - MPNowPlayingInfoPropertyPlaybackQueueCount: Total pending
      4. Create artwork images for action types (file_edit, bash, etc.)
      5. Add CPNowPlayingTemplate to interface controller
      6. Update display when pending actions change

      Pattern:
      ```swift
      func updateNowPlayingInfo() {
          guard let action = currentAction else { return }
          var info = [String: Any]()
          info[MPMediaItemPropertyTitle] = action.title
          info[MPMediaItemPropertyArtist] = "Claude Code"
          info[MPMediaItemPropertyAlbumTitle] = state.taskName
          info[MPNowPlayingInfoPropertyPlaybackQueueIndex] = currentIndex
          info[MPNowPlayingInfoPropertyPlaybackQueueCount] = state.pendingActions.count
          MPNowPlayingInfoCenter.default().nowPlayingInfo = info
      }
      ```
    priority: critical
    parallel_group: 21
    completed: false
    depends_on:
      - "CP6"
    verification: |
      [ -f "ClaudeMobile/Scenes/CarPlay/CarPlayService.swift" ] && \
      grep -q 'MPNowPlayingInfoCenter\|NowPlayingInfo' ClaudeMobile/Scenes/CarPlay/CarPlayService.swift && \
      grep -q 'CPNowPlayingTemplate' ClaudeMobile/Scenes/CarPlay/CarPlaySceneDelegate.swift && exit 0 || exit 1
    acceptance_criteria:
      - "CarPlayService manages Now Playing state"
      - "NowPlayingInfo struct with all display fields"
      - "MPNowPlayingInfoCenter updates on state change"
      - "Action type artwork images"
      - "Queue index/count display"
    files:
      - "ClaudeMobile/Scenes/CarPlay/CarPlayService.swift"
      - "ClaudeMobile/Scenes/CarPlay/CarPlaySceneDelegate.swift"
    tags:
      - carplay
      - now-playing
      - media-player
    commit_template: "feat(carplay): Implement CPNowPlayingTemplate"

  - id: "CP8"
    title: "Configure MPRemoteCommandCenter for steering wheel controls"
    description: |
      Set up MPRemoteCommandCenter to handle steering wheel button presses
      for approve (▶▶), reject (◀◀), and narration toggle (▶️).

      Implementation:
      1. Add to CarPlayService.swift:
         - configureRemoteCommands()
         - handleNextTrackCommand() -> approve
         - handlePreviousTrackCommand() -> reject
         - handleTogglePlayPauseCommand() -> narration
      2. Enable required commands:
         - nextTrackCommand (▶▶ = approve)
         - previousTrackCommand (◀◀ = reject)
         - togglePlayPauseCommand (▶️ = narration)
      3. Return appropriate MPRemoteCommandHandlerStatus
      4. Call SharedService for approve/reject actions
      5. Update Now Playing info after each action

      Implementation:
      ```swift
      func configureRemoteCommands() {
          let commandCenter = MPRemoteCommandCenter.shared()

          commandCenter.nextTrackCommand.isEnabled = true
          commandCenter.nextTrackCommand.addTarget { [weak self] _ in
              guard let action = self?.currentAction else {
                  return .noActionableNowPlayingItem
              }
              Task {
                  try? await SharedService.shared.respondToRequest(action.id, approved: true)
              }
              self?.playAudioFeedback(.approved)
              return .success
          }

          commandCenter.previousTrackCommand.isEnabled = true
          commandCenter.previousTrackCommand.addTarget { [weak self] _ in
              guard let action = self?.currentAction else {
                  return .noActionableNowPlayingItem
              }
              Task {
                  try? await SharedService.shared.respondToRequest(action.id, approved: false)
              }
              self?.playAudioFeedback(.rejected)
              return .success
          }
      }
      ```
    priority: critical
    parallel_group: 21
    completed: false
    depends_on:
      - "CP7"
    verification: |
      grep -q 'MPRemoteCommandCenter' ClaudeMobile/Scenes/CarPlay/CarPlayService.swift && \
      grep -q 'nextTrackCommand\|previousTrackCommand' ClaudeMobile/Scenes/CarPlay/CarPlayService.swift && \
      grep -q 'togglePlayPauseCommand' ClaudeMobile/Scenes/CarPlay/CarPlayService.swift && exit 0 || exit 1
    acceptance_criteria:
      - "MPRemoteCommandCenter configured"
      - "nextTrackCommand -> approve action"
      - "previousTrackCommand -> reject action"
      - "togglePlayPauseCommand -> toggle narration"
      - "Proper return values for all commands"
    files:
      - "ClaudeMobile/Scenes/CarPlay/CarPlayService.swift"
    tags:
      - carplay
      - steering-wheel
      - remote-commands
      - critical
    commit_template: "feat(carplay): Configure steering wheel controls"

  - id: "CP9"
    title: "Add audio feedback system for CarPlay"
    description: |
      Create AudioService for audio cues and feedback tones in CarPlay.

      Implementation:
      1. Create ClaudeMobile/Services/AudioService.swift
      2. Define AudioCue enum:
         - newApproval, approved, rejected, allComplete
         - connectionLost, voicePromptStart, voicePromptEnd
      3. Load audio files from Resources/:
         - approved.wav, rejected.wav, chime.wav, warning.wav
      4. Create AVAudioPlayer instances for each cue
      5. Configure audio session for CarPlay:
         - AVAudioSession.Category.playback
         - AVAudioSession.Mode.default
      6. Play appropriate cue on events
    priority: high
    parallel_group: 21
    completed: false
    depends_on:
      - "CP7"
    verification: |
      [ -f "ClaudeMobile/Services/AudioService.swift" ] && \
      grep -q 'AVAudioPlayer\|AudioCue' ClaudeMobile/Services/AudioService.swift && exit 0 || exit 1
    acceptance_criteria:
      - "AudioService with audio cue playback"
      - "AudioCue enum with all event types"
      - "Audio session configured for CarPlay"
      - "Sound files in Resources/"
      - "Plays on approve/reject events"
    files:
      - "ClaudeMobile/Services/AudioService.swift"
      - "ClaudeMobile/Resources/"
    tags:
      - carplay
      - audio
      - feedback
    commit_template: "feat(carplay): Add audio feedback system"

  - id: "CP10"
    title: "Add connection status display for CarPlay"
    description: |
      Display connection status in CarPlay UI and handle disconnection gracefully.

      Implementation:
      1. Add connection status to Now Playing subtitle
      2. Show CPAlertTemplate on connection loss
      3. Add reconnection UI with progress
      4. Update MPNowPlayingInfo with status
      5. Audio cue on connection change
    priority: medium
    parallel_group: 21
    completed: false
    depends_on:
      - "CP7"
      - "CP9"
    verification: |
      grep -q 'ConnectionStatus\|connectionLost\|Offline\|Reconnecting' ClaudeMobile/Scenes/CarPlay/CarPlayService.swift && exit 0 || exit 1
    acceptance_criteria:
      - "Connection status in Now Playing subtitle"
      - "Alert on connection loss"
      - "Reconnection progress display"
      - "Audio cue on status change"
    files:
      - "ClaudeMobile/Scenes/CarPlay/CarPlayService.swift"
    tags:
      - carplay
      - connection
      - status
    commit_template: "feat(carplay): Add connection status display"

  # --- Phase 8.3: Voice & Audio Narration (parallel_group: 22) ---
  - id: "CP11"
    title: "Implement AVSpeechSynthesizer narration"
    description: |
      Add text-to-speech narration for pending actions using AVSpeechSynthesizer.
    priority: high
    parallel_group: 22
    completed: false
    depends_on:
      - "CP7"
    verification: |
      [ -f "ClaudeMobile/Services/NarrationService.swift" ] && \
      grep -q 'AVSpeechSynthesizer\|AVSpeechUtterance' ClaudeMobile/Services/NarrationService.swift && exit 0 || exit 1
    acceptance_criteria:
      - "NarrationService with AVSpeechSynthesizer"
      - "Action-specific narration text"
      - "Configurable voice and rate"
      - "Auto-narration on new approvals"
    files:
      - "ClaudeMobile/Services/NarrationService.swift"
    tags:
      - carplay
      - voice
      - tts
    commit_template: "feat(carplay): Implement TTS narration"

  - id: "CP12"
    title: "Create SiriKit intents for voice control"
    description: |
      Define SiriKit intents for hands-free voice control of Claude Code.
    priority: high
    parallel_group: 22
    completed: false
    depends_on:
      - "CP3"
    verification: |
      [ -f "ClaudeMobile/Intents/IntentHandler.swift" ] && \
      grep -q 'ClaudeApproveIntent\|INExtension' ClaudeMobile/Intents/IntentHandler.swift && exit 0 || exit 1
    acceptance_criteria:
      - "Intents.intentdefinition with all intents"
      - "IntentHandler implements all handlers"
      - "Siri entitlement configured"
    files:
      - "ClaudeMobile/Intents/Intents.intentdefinition"
      - "ClaudeMobile/Intents/IntentHandler.swift"
    tags:
      - carplay
      - siri
      - voice
    commit_template: "feat(carplay): Create SiriKit intents"

  - id: "CP13"
    title: "Add narration preferences to settings"
    description: |
      Add user-configurable audio/narration preferences.
    priority: medium
    parallel_group: 22
    completed: false
    depends_on:
      - "CP4"
      - "CP11"
    verification: |
      grep -q 'AudioPreferences\|narrationEnabled' Shared/Models/SharedModels.swift && exit 0 || exit 1
    acceptance_criteria:
      - "AudioPreferences Codable struct"
      - "Settings UI for all preferences"
      - "Preferences stored in App Group"
    files:
      - "Shared/Models/SharedModels.swift"
      - "ClaudeMobile/Views/SettingsView.swift"
    tags:
      - carplay
      - settings
      - preferences
    commit_template: "feat(carplay): Add narration preferences"

  - id: "CP14"
    title: "Add risk assessment to MCP server"
    description: |
      Add watch_assess_risk MCP tool to evaluate action risk level for CarPlay.
    priority: medium
    parallel_group: 22
    completed: false
    verification: |
      grep -q 'watch_assess_risk\|_handle_assess_risk' MCPServer/server.py && exit 0 || exit 1
    acceptance_criteria:
      - "watch_assess_risk MCP tool defined"
      - "Risk levels: high, medium, low"
      - "Sensitive file detection"
    files:
      - "MCPServer/server.py"
    tags:
      - carplay
      - server
      - mcp
    commit_template: "feat(api): Add risk assessment MCP tool"

  - id: "CP15"
    title: "Add voice prompt API endpoints to cloud relay"
    description: |
      Add API endpoints for voice prompt flow to cloud relay worker.
    priority: low
    parallel_group: 22
    completed: false
    verification: |
      grep -q '/voice/prompt\|/voice/response' MCPServer/worker/src/index.js && exit 0 || exit 1
    acceptance_criteria:
      - "POST /voice/prompt endpoint"
      - "GET /voice/response/{promptId} endpoint"
    files:
      - "MCPServer/worker/src/index.js"
    tags:
      - carplay
      - server
      - api
    commit_template: "feat(api): Add voice prompt endpoints"

  # --- Phase 8.5: Testing & Polish (parallel_group: 23) ---
  - id: "CP16"
    title: "Add CarPlay unit tests"
    description: |
      Create unit tests for CarPlay functionality.
    priority: medium
    parallel_group: 23
    completed: false
    depends_on:
      - "CP8"
      - "CP11"
    verification: |
      [ -f "ClaudeMobile/Tests/CarPlayServiceTests.swift" ] && exit 0 || exit 1
    acceptance_criteria:
      - "CarPlayServiceTests with steering wheel tests"
      - "NarrationServiceTests with text building tests"
      - "All tests pass"
    files:
      - "ClaudeMobile/Tests/CarPlayServiceTests.swift"
      - "ClaudeMobile/Tests/NarrationServiceTests.swift"
    tags:
      - carplay
      - testing
    commit_template: "test(carplay): Add CarPlay unit tests"

  - id: "CP17"
    title: "Add integration tests for pairing flow"
    description: |
      Create integration tests for the complete pairing flow.
    priority: medium
    parallel_group: 23
    completed: false
    depends_on:
      - "CP16"
    verification: |
      [ -f "ClaudeMobile/Tests/IntegrationTests.swift" ] && exit 0 || exit 1
    acceptance_criteria:
      - "QR code pairing flow test"
      - "CarPlay state sync test"
    files:
      - "ClaudeMobile/Tests/IntegrationTests.swift"
    tags:
      - carplay
      - testing
    commit_template: "test(carplay): Add integration tests"

  - id: "CP18"
    title: "Add Watch ↔ CarPlay state sync"
    description: |
      Ensure state is properly synchronized between Watch and CarPlay via App Groups.
    priority: medium
    parallel_group: 23
    completed: false
    depends_on:
      - "CP3"
      - "CP7"
    verification: |
      grep -q 'watchActive\|carPlayActive' ClaudeMobile/Services/SharedService.swift && exit 0 || exit 1
    acceptance_criteria:
      - "State observers for all changes"
      - "App Group persistence"
      - "Conflict resolution strategy"
    files:
      - "ClaudeMobile/Services/SharedService.swift"
    tags:
      - carplay
      - watch
      - state-sync
    commit_template: "feat(carplay): Add Watch ↔ CarPlay state sync"

  - id: "CP19"
    title: "Handle edge cases (connection loss, etc.)"
    description: |
      Handle edge cases and error conditions gracefully.
    priority: medium
    parallel_group: 23
    completed: false
    depends_on:
      - "CP10"
    verification: |
      grep -q 'handleConnectionLoss\|CPAlertTemplate' ClaudeMobile/Scenes/CarPlay/CarPlayService.swift && exit 0 || exit 1
    acceptance_criteria:
      - "Connection loss alert with retry"
      - "Empty state handling"
      - "Steering wheel command debouncing"
    files:
      - "ClaudeMobile/Scenes/CarPlay/CarPlayService.swift"
    tags:
      - carplay
      - error-handling
    commit_template: "fix(carplay): Handle edge cases and errors"

  - id: "CP20"
    title: "App Store submission preparation"
    description: |
      Prepare the iOS app for App Store submission.
    priority: low
    parallel_group: 23
    completed: false
    depends_on:
      - "CP16"
      - "CP17"
      - "CP18"
      - "CP19"
    verification: |
      [ -f "ClaudeMobile/Info.plist" ] && exit 0 || exit 1
    acceptance_criteria:
      - "All entitlements configured"
      - "All Info.plist keys present"
      - "CarPlay entitlement requested"
    files:
      - "ClaudeMobile/Info.plist"
      - "ClaudeMobile/ClaudeMobile.entitlements"
    tags:
      - carplay
      - app-store
    commit_template: "chore(carplay): App Store submission preparation"
